{"version":3,"file":"y-dexie.js","sources":["../src/helpers/hasOwn.ts","../src/createYjsMiddleware.ts","../src/docCache.ts","../src/getOrCreateDocument.ts","../src/createYDocProperty.ts","../src/compressYDocs.ts","../src/periodicGC.ts","../src/currentUpdateRow.ts","../src/observeYDocUpdates.ts","../src/helpers/nop.ts","../src/helpers/promisableChain.ts","../src/helpers/nonStoppableEventChain.ts","../src/DexieYProvider.ts","../src/y-dexie.ts"],"sourcesContent":["const _hasOwn = {}.hasOwnProperty;\nexport const hasOwn = (obj: object, prop: PropertyKey): boolean => {\n  return _hasOwn.call(obj, prop);\n};\n","import { DBCore, DBCoreTable, DBCoreMutateResponse } from 'dexie';\nimport * as Y from 'yjs';\nimport { DbSchema } from 'dexie';\nimport { YUpdateRow } from './types/YUpdateRow';\nimport { hasOwn } from './helpers/hasOwn';\n\nconst EMPTY_ARRAY = [] as const; // Optimization of returning empty array frequently in flatMap operaion.\n\nexport function createYjsMiddleware(dbSchema: DbSchema) {\n  return (downCore: DBCore) =>\n    ({\n      ...downCore,\n      table(tableName: string) {\n        const downTable = downCore.table(tableName);\n        const dbTableSchema = dbSchema[tableName]; // DBCore don't understand Yjs specific schema - need dexie xchema\n        const { yProps } = dbTableSchema;\n        if (!yProps || yProps.length === 0) return downTable;\n        const tableMiddleware: DBCoreTable = {\n          ...downTable,\n          mutate(req): Promise<DBCoreMutateResponse> {\n            if (req.type !== 'add' && req.type !== 'put')\n              return downTable.mutate(req);\n            // From here on, req.type is \"add\":\n            let reqClone = req;\n            const updateSources = yProps\n              .map((p) => ({\n                p,\n                entries: req.values.flatMap<{\n                  // Instead of map().filter() we use flatMap() to avoid creating intermediate arrays.\n                  iter: number;\n                  u: Uint8Array;\n                }>((value, iter) => {\n                  if (!value || typeof value !== 'object')\n                    throw new TypeError(\n                      `Table ${tableName} (with Y-properties) must only contain objects`\n                    );\n                  if (!hasOwn(value, p.prop)) return [];\n                  // Clone req, req.values and each value so that we can delete yProps from being stored:\n                  if (reqClone === req)\n                    reqClone = {\n                      ...req,\n                      values: req.values.map((v) => ({ ...v })),\n                    };\n                  // Delete prop so that it isn't physically stored in DB\n                  delete reqClone.values[iter][p.prop];\n\n                  const doc = value[p.prop] as Y.Doc | undefined | null;\n                  if (doc === null)\n                    throw new TypeError(`Cannot set Y property to null`);\n                  // Allow undefined, treat it as if the object didn't have the property at all.\n                  if (doc === undefined) return EMPTY_ARRAY;\n                  // Check that the property is of type Y.Doc:\n                  if (typeof doc !== 'object' || !('whenLoaded' in doc)) {\n                    throw new TypeError(\n                      `Y properties can only be inited with an Y.Doc instance or undefined to create an empty Y.Doc`\n                    );\n                  }\n                  if (req.type === 'put')\n                    // Don't allow setting y properties on put requests\n                    throw new TypeError(\n                      `Setting ${tableName}.${p.prop} (declared as ${p.prop}:Y) is only allowed when inserting new objects using db.${tableName}.add(), not put() or update().`\n                    );\n                  if (Y.encodeStateVector(doc).length === 1) {\n                    // Document is empty and has no updates\n                    return EMPTY_ARRAY;\n                  }\n                  // Clone the Yjs state before storing it in the database\n                  return {\n                    iter,\n                    u: Y.encodeStateAsUpdateV2(doc),\n                  };\n                }),\n              }))\n              .filter(({ entries }) => entries.length > 0);\n            if (req === reqClone)\n              // No object had their Y-props in own props - no need to intercept.\n              return downTable.mutate(req);\n\n            // We have a reqClone to forward down the stack. The reqClone\n            // is a copy of req, but where some objects have their yProps deleted.\n            return downTable.mutate(reqClone).then((res) => {\n              if (updateSources.length === 0)\n                // No updates to create (but user provided empty Y.Docs so reqClone was still needed)\n                return res;\n              // For each yProp affect, write docs (monolit-updates) to their corresponding tables.\n              return Promise.all(\n                updateSources.map(({ p, entries }) => {\n                  const updatesTable = downCore.table(p.updatesTable);\n                  const updatesToInsert: Omit<YUpdateRow, 'i'>[] = entries.map(\n                    ({ iter, u }) =>\n                      ({\n                        k: res.results![iter],\n                        u,\n                        f: 1, // Flag as local update (to be included when syncing)\n                      } satisfies Omit<YUpdateRow, 'i'>)\n                  );\n                  return updatesTable.mutate({\n                    type: 'add',\n                    values: updatesToInsert,\n                    trans: req.trans,\n                  });\n                })\n              ).then(() => res);\n            });\n          },\n        };\n        return tableMiddleware;\n      },\n    } satisfies DBCore);\n}\n","import { Dexie } from 'dexie';\nimport * as Y from 'yjs';\nimport { YDocCache } from './types/YDocCache';\nimport { DexieYDocMeta } from './types/DexieYDocMeta';\n\n// The finalization registry\nconst docRegistry = new FinalizationRegistry<{cache: any, key: string}>(({cache, key}) => {\n  delete cache[key];\n});\n\n// The Y.Doc cache containing all active documents\nexport function getDocCache(db: Dexie): YDocCache {\n  return db._novip['_docCache'] ??= {\n    cache: {} as { [key: string]: WeakRef<Y.Doc>; },\n    get size() {\n      return Object.keys(this.cache).length;\n    },\n    find(table: string, primaryKey: any, ydocProp: string): Y.Doc | undefined {\n      const cacheKey = getYDocCacheKey(table, primaryKey, ydocProp);\n      const docRef = this.cache[cacheKey];\n      return docRef ? docRef.deref() : undefined;\n    },\n    add(doc: Y.Doc): void {\n      const { parentTable, parentId, parentProp } = doc.meta as DexieYDocMeta;\n      if (!parentTable || !parentProp || parentId == null)\n        throw new Error(`Missing Dexie-related metadata in Y.Doc`);\n      const cacheKey = getYDocCacheKey(parentTable, parentId, parentProp);\n      const existingDoc = this.cache[cacheKey]?.deref();\n      if (existingDoc) {\n        docRegistry.unregister(existingDoc); // Don't run garbage collection on this doc as it is being replaced.\n      }\n      this.cache[cacheKey] = new WeakRef(doc);\n      docRegistry.register(doc, { cache: this.cache, key: cacheKey }, doc);\n    },\n    delete(doc: Y.Doc): void {\n      docRegistry.unregister(doc); // Don't run garbage collection on this doc as it is being deleted here and now.\n      const cacheKey = getYDocCacheKey(doc.meta.parentTable, doc.meta.parentId, doc.meta.parentProp);\n      const cacheEntry = this.cache[cacheKey];\n      if (cacheEntry?.deref() === doc) {\n        delete this.cache[cacheKey]; // Remove the entry from the cache only if it is the same doc.\n      }\n    },\n  };\n}\n\n// Emulate a private boolean property \"destroyed\" on Y.Doc instances that we manage\n// in createYDocProperty.ts:\nexport const destroyedDocs = new WeakSet<object>();\n\nexport function throwIfDestroyed(doc: any) {\n  if (destroyedDocs.has(doc))\n    throw new Error(`Y.Doc ${doc.meta.parentId} has been destroyed`);\n}\n\nexport function getYDocCacheKey(table: string, primaryKey: any, ydocProp: string): string {\n  return `${table}[${primaryKey}].${ydocProp}`;\n}\n","import type { Dexie } from 'dexie';\nimport { destroyedDocs } from './docCache';\nimport { YDocCache } from './types/YDocCache';\nimport * as Y from 'yjs';\nimport { DexieYDocMeta } from './types/DexieYDocMeta';\n\nexport function getOrCreateDocument(\n  db: Dexie,\n  docCache: YDocCache,\n  tableName: string,\n  prop: string,\n  updatesTable: string,\n  id: any\n) {\n  let doc = docCache.find(tableName, id, prop);\n  if (doc) return doc;\n\n  doc = new Y.Doc({\n    meta: {\n      db,\n      updatesTable,\n      parentProp: prop,\n      parentTable: tableName,\n      parentId: id,\n    } satisfies DexieYDocMeta,\n  });\n\n  docCache.add(doc);\n\n  doc.on('destroy', () => {\n    destroyedDocs.add(doc);\n    docCache.delete(doc);\n  });\n\n  return doc;\n}\n","import { Dexie, Table } from 'dexie';\nimport { getDocCache } from './docCache';\nimport { getOrCreateDocument } from './getOrCreateDocument';\n\nconst { getByKeyPath } = Dexie;\n\nexport function createYDocProperty(\n  db: Dexie,\n  table: Table,\n  prop: string,\n  updatesTable: string\n) {\n  const pkKeyPath = table.schema.primKey.keyPath;\n  if (!pkKeyPath) {\n    throw new Error(\n      `Cannot create Y.Doc property for ${table.name}.${prop} because the table has no inbound primary key. See https://dexie.org/docs/inbound`\n    );\n  }\n  const docCache = getDocCache(db);\n  return {\n    set() {\n      throw new TypeError(`Y.Doc properties are read-only`);\n    },\n    get(this: object) {\n      const id = getByKeyPath(this, pkKeyPath);\n      return getOrCreateDocument(\n        db,\n        docCache,\n        table.name,\n        prop,\n        updatesTable,\n        id\n      );\n    },\n  };\n}\n","import { Dexie, cmp } from 'dexie';\nimport { YLastCompressed } from './types/YLastCompressed';\nimport { YSyncState } from './types/YSyncState';\nimport { YUpdateRow } from './types/YUpdateRow';\nimport * as Y from 'yjs';\n\n/** Go through all Y.Doc tables in the entire local db and compress updates\n *\n * @param db Dexie\n * @returns\n */\nexport function compressYDocs(db: Dexie, skipIfRecentlyDoneMillisec?: number) {\n  let p: Promise<any> = Promise.resolve();\n  for (const table of db.tables) {\n    for (const yProp of table.schema.yProps || []) {\n      p = p.then(() => compressYDocsTable(db, yProp, skipIfRecentlyDoneMillisec));\n    }\n  }\n  return p;\n}\n\n/** Compress an individual Y.Doc table */\nfunction compressYDocsTable(\n  db: Dexie,\n  { updatesTable }: { prop: string; updatesTable: string },\n  skipIfRunnedSince?: number // milliseconds\n) {\n  const updTbl = db.table(updatesTable);\n  return Promise.all([\n    // syncers (for example dexie-cloud-addon or other 3rd part syncers) They may have unsentFrom set.\n    updTbl\n      .where('i')\n      .startsWith('') // Syncers have string primary keys while updates have auto-incremented numbers.\n      .toArray(),\n\n    // lastCompressed (pointer to the last compressed update)\n    db.transaction('rw', updatesTable, () =>\n      updTbl.get(0).then((lastCompressed: YLastCompressed | undefined) => {\n        if (\n          skipIfRunnedSince &&\n          lastCompressed &&\n          lastCompressed.lastRun &&\n          lastCompressed.lastRun.getTime() > Date.now() - skipIfRunnedSince\n        ) {\n          // Skip it. It has run recently or is still running.\n          return null;\n        }\n        // isRunning might be true but we don't respect it if started before skipIfRunningSince.\n        lastCompressed = lastCompressed || { i: 0, lastCompressed: 0 };\n        return updTbl\n          .put({\n            ...lastCompressed,\n            lastRun: new Date(),\n          })\n          .then(() => lastCompressed);\n      })\n    ),\n  ]).then(([syncers, stamp]: [YSyncState[], YLastCompressed]) => {\n    if (!stamp) return; // Skip. Already running.\n    const lastCompressedUpdate = stamp.lastCompressed;\n    const unsyncedFrom = Math.min(\n      ...syncers.map((s) =>\n        Math.min(\n          s.unsentFrom || Infinity,\n          s.receivedUntil != null ? s.receivedUntil + 1 : Infinity\n        )\n      )\n    );\n    // Per updates-table:\n    // 1. Find all updates after lastCompressedId. Run toArray() on them.\n    // 2. IF there are any \"mine\" (flagged) updates AFTER unsentFrom, skip all from including this entry, else include all regardless of unsentFrom.\n    // 3. Now we know which keys have updates since last compression. We also know how far we're gonna go (max unsentFrom unless all additional updates are foreign).\n    // 4. For every key that had updates, load their main update (this is one single update per key before the lastCompressedId marker)\n    // 5. For every key that had updates: Compress main update along with additional updates until and including the number that was computed on step 2 (could be Infinity).\n    // 6. Update lastCompressedId to the i of the latest compressed entry.\n    return updTbl\n      .where('i')\n      .between(lastCompressedUpdate, Infinity, false)\n      .toArray((addedUpdates: YUpdateRow[]) => {\n        if (addedUpdates.length === 0) return; // No more updates where added\n        const docsToCompress: { docId: any; updates: YUpdateRow[] }[] = [];\n        let lastUpdateToCompress = lastCompressedUpdate;\n        for (let j = 0; j < addedUpdates.length; ++j) {\n          const updateRow = addedUpdates[j];\n          const { i, f, k } = updateRow;\n          if (i >= unsyncedFrom && f && f & 0x01) break; // An update that need to be synced was found. Stop here and let dontCompressFrom stay.\n          const entry = docsToCompress.find(\n            (entry) => cmp(entry.docId, k) === 0\n          );\n          if (entry) entry.updates.push(updateRow);\n          else docsToCompress.push({ docId: k, updates: [updateRow] });\n          lastUpdateToCompress = i;\n        }\n        if (lastUpdateToCompress === lastCompressedUpdate) return; // No updates to compress\n        let p = Promise.resolve();\n        for (const { docId, updates } of docsToCompress) {\n          p = p.then(() =>\n            compressUpdatesForDoc(db, updatesTable, docId, updates)\n          );\n        }\n        return p.then(() => {\n          // Update lastCompressed atomically to the value we computed.\n          // Do it with respect to the case when another job was done in parallel\n          // that maybe compressed one or more extra updates and updated lastCompressed\n          // before us.\n          return db.transaction('rw', updTbl, () =>\n            updTbl.get(0).then((current: YLastCompressed) => {\n              if (current && lastUpdateToCompress <= current.lastCompressed) {\n                // No need to update. Nothing was done, or another job did more.\n                return;\n              }\n              return updTbl.put({\n                ...current,\n                lastCompressed: lastUpdateToCompress,\n              });\n            })\n          );\n        });\n      });\n  });\n}\n\nexport function compressUpdatesForDoc(\n  db: Dexie,\n  updatesTable: string,\n  parentId: any,\n  addedUpdatesToCompress: YUpdateRow[]\n) {\n  if (addedUpdatesToCompress.length < 1) throw new Error('Invalid input');\n  return db.transaction('rw', updatesTable, (tx) => {\n    const updTbl = tx.table(updatesTable);\n    return updTbl.where({ k: parentId }).first((mainUpdate: YUpdateRow) => {\n      if (!mainUpdate) return; // No main update found. Nothing to compress.\n      const updates = [mainUpdate].concat(\n        addedUpdatesToCompress.filter((u) => u.i !== mainUpdate.i)\n      ); // avoid duplicating the main update (can happen sometimes)\n      const doc = new Y.Doc({ gc: true });\n      updates.forEach((update) => {\n        Y.applyUpdateV2(doc, update.u);\n      });\n      const compressedUpdate = Y.encodeStateAsUpdateV2(doc);\n      const lastUpdate = updates.pop()!;\n      return updTbl\n        .put({\n          i: lastUpdate.i,\n          k: parentId,\n          u: compressedUpdate,\n        })\n        .then(() => updTbl.bulkDelete(updates.map((update) => update.i)));\n    });\n  });\n}\n","import { Dexie } from 'dexie';\nimport { compressYDocs } from './compressYDocs';\n\nconst GC_DELAY = 10_000; // Delay before starting GC when DB is started\nconst GC_INTERVAL = 300_000; // Every 5 minutes\n\nexport function periodicGC(db: Dexie) {\n  let timer: any = null;\n  db.on(\n    'ready',\n    (db: Dexie) => {\n      if (db.tables.some(tbl => tbl.schema.yProps)) {\n        const gc = () => {\n          if (!db.isOpen()) return;\n          compressYDocs(db, GC_INTERVAL).catch(err => {\n            if (err && err.name === 'DatabaseClosedError') return;\n            console.debug('Error during periodic GC', err);\n          }).then(() => {\n            timer = setTimeout(gc, GC_INTERVAL);\n          });\n        };\n        timer = setTimeout(gc, GC_DELAY);\n      }\n    },\n    true\n  );\n  db.on('close', () => {\n    if (timer) clearTimeout(timer);\n    timer = null;\n  });\n}\n","import type { YUpdateRow } from './types/YUpdateRow';\n\nexport let currentUpdateRow: YUpdateRow | null = null;\n\nexport function setCurrentUpdateRow(row: YUpdateRow | null) {\n  currentUpdateRow = row;\n}\n","import type { Dexie } from 'dexie';\nimport * as Y from 'yjs';\nimport { YUpdateRow } from './types/YUpdateRow';\nimport type { EntityTable } from 'dexie';\nimport { throwIfDestroyed } from './docCache';\nimport { liveQuery } from 'dexie';\nimport { cmp } from 'dexie';\nimport { setCurrentUpdateRow } from './currentUpdateRow';\nimport type { DexieYProvider } from './DexieYProvider';\n\nexport function observeYDocUpdates(\n  provider: DexieYProvider,\n  doc: Y.Doc,\n  db: Dexie,\n  parentTableName: string,\n  updatesTableName: string,\n  parentId: any\n): () => void {\n  let lastUpdateId = 0;\n  let initial = true;\n  const subscription = liveQuery(() => {\n    throwIfDestroyed(doc);\n    const updatesTable = db.table(updatesTableName) as EntityTable<\n      YUpdateRow,\n      'i'\n    >;\n    return Promise.all([\n      (lastUpdateId > 0\n        ? updatesTable\n            .where('i')\n            .between(lastUpdateId, Infinity, false)\n            .toArray()\n            .then((updates) =>\n              updates.filter((update) => cmp(update.k, parentId) === 0)\n            )\n        : updatesTable.where({ k: parentId }).toArray()\n      ).then((updates) => {\n        return updates;\n      }),\n      db.table(parentTableName).where(':id').equals(parentId).toArray(), // Why not just count() or get()? Because of cache only works with toArray() currently (optimization)\n    ]);\n  }).subscribe(\n    ([updates, parentRow]) => {\n      if (updates.length > 0) lastUpdateId = updates[updates.length - 1].i;\n      if (parentRow.length === 0) {\n        // Row deleted. Destroy Y.Doc.\n        doc.destroy();\n        return;\n      }\n      throwIfDestroyed(doc);\n      if (updates.length > 0) {\n        Y.transact(\n          doc,\n          () => {\n            updates.forEach((update) => {\n              try {\n                setCurrentUpdateRow(update);\n                Y.applyUpdateV2(doc, update.u);\n              } finally {\n                setCurrentUpdateRow(null);\n              }\n            });\n          },\n          provider,\n          false\n        );\n      }\n      if (initial) {\n        initial = false;\n        doc.emit('load', [doc]);\n      }\n    },\n    (error) => {\n      provider.on('error').fire(error);\n    }\n  );\n\n  const onUpdate = (update: Uint8Array, origin: any) => {\n    if (origin === provider) return; // Already applied.\n    db.table(updatesTableName)\n      .add({\n        k: parentId,\n        u: update,\n        f: 1, // Flag as local update (to be included when syncing)\n      } satisfies Omit<YUpdateRow, 'i'>)\n      .then((i: number) => {\n        // Optimization (not critical): Don't query for this update to put it back into the doc.\n        // However, skip this optimization if the lastUpdateId is behind the current update.\n        // In that case, next liveQuery emission will include also this update and re-apply it into doc,\n        // but it will not be an issue because Y.Doc will ignore duplicate updates.\n        if (i === lastUpdateId - 1) ++lastUpdateId;\n      })\n      .catch((error) => {\n        provider.on('error').fire(error);\n      });\n  };\n\n  const stopObserving = () => {\n    subscription.unsubscribe();\n    doc.off('updateV2', onUpdate);\n    doc.off('destroy', stopObserving);\n  };\n\n  doc.on('updateV2', onUpdate);\n  doc.on('destroy', stopObserving);\n\n  return stopObserving;\n}\n","export function nop() {}","import { nop } from \"./nop\";\n\nexport function promisableChain(f1, f2) {\n    if (f1 === nop) return f2;\n    return function () {\n        var res = f1.apply(this, arguments);\n        if (res && typeof res.then === 'function') {\n            var thiz = this,\n                i = arguments.length,\n                args = new Array(i);\n            while (i--) args[i] = arguments[i];\n            return res.then(function () {\n                return f2.apply(thiz, args);\n            });\n        }\n        return f2.apply(this, arguments);\n    };\n}\n","import { nop } from \"./nop\";\n\nexport function nonStoppableEventChain(f1: Function, f2: Function) {\n    if (f1 === nop) return f2;\n    return function () {\n        f1.apply(this, arguments);\n        f2.apply(this, arguments);\n    };\n}\n","import { Dexie, DexieEvent, DexieEventSet, Unsubscribable } from 'dexie';\nimport * as Y from 'yjs';\nimport { throwIfDestroyed, getDocCache, destroyedDocs } from './docCache';\nimport { getOrCreateDocument } from './getOrCreateDocument';\nimport { observeYDocUpdates } from './observeYDocUpdates';\nimport { promisableChain } from './helpers/promisableChain';\nimport { nonStoppableEventChain } from './helpers/nonStoppableEventChain';\nimport { currentUpdateRow } from './currentUpdateRow';\nimport { Disposable } from './helpers/Disposable';\n\nconst wm = new WeakMap<any, DexieYProvider>();\n\nfunction createEvents() {\n  return (Dexie.Events as any)(null, 'load', 'sync', 'error') as DexieYProvider['on'];\n}\n\ninterface ReleaseOptions {\n  gracePeriod?: number; // Grace period to optimize for unload/reload scenarios\n}\n\nclass DexieYProvider\n{\n  refCount = 1;\n  private stopObserving: () => void;\n  private cleanupHandlers: (() => void)[] = [];\n  private graceTimer: any;\n  private graceTimeout = -1;\n  doc: Y.Doc | null = null;\n  awareness?: any;\n  private _error?: any;\n\n  private _whenLoaded: Promise<void>;\n  private _whenSynced: Promise<void>;\n\n  on: DexieEventSet & ((name: string, f: (...args: any[]) => any) => void);\n  off: (name: string, f: (...args: any[]) => any) => void;\n\n  destroyed = false;\n\n  static on = (Dexie.Events as any)(null, {\n    new: [nonStoppableEventChain],\n    beforeunload: [promisableChain],\n  }) as DexieEventSet & ((name: string, f: (...args: any[]) => any) => void) & {\n    new: DexieEvent;\n    beforeunload: DexieEvent;\n  };\n\n  static getOrCreateDocument(db: Dexie, table: string, prop: string, id: any) {\n    const docCache = getDocCache(db);\n    const updatesTable = db\n      .table(table)\n      .schema.yProps?.find((p) => p.prop === prop)?.updatesTable;\n    if (!updatesTable) {\n      throw new Error(`Updates table for ${table}.${prop} not found`);\n    }\n    // Get or create the Y.Doc for the given table, prop, and id\n    return getOrCreateDocument(db, docCache, table, prop, updatesTable, id);\n  }\n\n  static load(\n    doc: Y.Doc,\n    options?: ReleaseOptions\n  ): DexieYProvider {\n    let p = wm.get(doc);\n    if (p) {\n      ++p.refCount;\n      if (\n        options?.gracePeriod != null &&\n        p.graceTimeout < options.gracePeriod\n      ) {\n        p.graceTimeout = options.gracePeriod;\n      }\n      if (p.graceTimer) {\n        clearTimeout(p.graceTimer);\n        p.graceTimer = null;\n      }\n    } else {\n      p = new DexieYProvider(doc);\n      p.graceTimeout = options?.gracePeriod ?? -1;\n      wm.set(doc, p);\n    }\n    return p;\n  }\n\n  static release(doc: Y.Doc) {\n    if (!doc || destroyedDocs.has(doc)) return; // Document already destroyed.\n    const p = wm.get(doc);\n    if (p) {\n      // There is a provider connected to the doc\n      if (--p.refCount <= 0) {\n        // No references to this provider anymore. Time to release it.\n        if (p.graceTimeout < 0) {\n          // No grace period here or from previous release. Release immediately.\n          p._release();\n        } else if (!p.graceTimer) {\n          p.graceTimer = setTimeout(\n            () => {\n              p.graceTimer = null;\n              if (p.refCount === 0) {\n                // Release only if refCount is still zero\n                p._release();\n              }\n            },\n            p.graceTimeout // Grace period to optimize for unload/reload scenarios\n          );\n        }\n      }\n    } else {\n      doc.destroy();\n    }\n  }\n\n  private _release() {\n    // Allow a listener to beforeunload event to execute while the provider and the document\n    // are still alive and loaded if it needs to compute something from the full document.\n    // Also, in case the event listener uses DexieYProvider.load() without calling DexieYProvider.release(),\n    // it must prevent the release to happen until the provider is finally released.\n    if (!this.doc) return;\n    Promise.resolve(DexieYProvider.on('beforeunload').fire(this)).finally(\n      () => {\n        // Re-check that refCount is zero before actually destroying the document (which\n        // leads to provider.destroy() through the destroy-event on the doc).\n        if (this.refCount === 0) {\n          this.doc?.destroy();\n        }\n        // If refCount is not zero, it means that DexieYProvider.load() has been called from the listener\n        // and the listener has prevented the release from happening. The listener must call DexieYProvider.release()\n        // when it's done with the document.\n      }\n    );\n  }\n\n  static for(doc: Y.Doc): DexieYProvider | undefined {\n    return wm.get(doc);\n  }\n  static getDocCache = getDocCache;\n  static get currentUpdateRow() {\n    return currentUpdateRow;\n  }\n\n  // Use a getter to avoid unhandled rejections when no one bothers about it.\n  get whenLoaded(): Promise<void> {\n    if (!this._whenLoaded) {\n      this._whenLoaded = new Promise((resolve, reject) => {\n        if (!this.doc) {\n          reject(new Error('No Y.Doc associated with this provider'));\n          return;\n        }\n        if (this.doc.isLoaded) resolve();\n        else if (this._error) reject(this._error);\n        else if (destroyedDocs.has(this.doc)) {\n          reject(new Dexie.AbortError('Document was destroyed before loaded'));\n        } else {\n          this.on('load', resolve);\n          this.on('error', reject);\n          this.doc.on('destroy', () =>\n            reject(new Dexie.AbortError('Document was destroyed before loaded'))\n          );\n        }\n      });\n    }\n    return this._whenLoaded;\n  }\n\n  // Use a getter to avoid unhandled rejections when no one bothers about it.\n  get whenSynced(): Promise<void> {\n    if (!this._whenSynced) {\n      this._whenSynced = new Promise((resolve, reject) => {\n        if (!this.doc) {\n          reject(new Error('No Y.Doc associated with this provider'));\n          return;\n        }\n        if (this.doc.isSynced) resolve();\n        else if (this._error) reject(this._error);\n        else if (destroyedDocs.has(this.doc)) {\n          reject(new Dexie.AbortError('Document was destroyed before synced'));\n        } else {\n          this.on('sync', resolve);\n          this.on('error', reject);\n          this.doc.on('destroy', () =>\n            reject(new Dexie.AbortError('Document was destroyed before synced'))\n          );\n        }\n      });\n    }\n    return this._whenSynced;\n  }\n\n  constructor(doc: Y.Doc) {\n    this.on = createEvents();\n    this.doc = doc;\n    this.off = (name: string, f: Function) => this.on[name]?.unsubscribe(f);\n    if ('dispose' in Symbol) {\n      // @ts-ignore\n      this[Symbol.dispose] = () => DexieYProvider.release(doc);\n    }\n    doc.on('load', () => this.on('load').fire());\n    doc.on('sync', (sync) => sync !== false && this.on('sync').fire());\n    doc.on('destroy', this.destroy.bind(this));\n    this.on('error', (error) => {\n      // In case error happens before awaiting provider.whenLoaded or provider.whenSynced.\n      this._error = error;\n    });\n\n    const { db, parentTable, parentId, updatesTable } =\n      (doc as Y.Doc).meta || {};\n    if (!db || !parentTable || !updatesTable) {\n      throw new Error(\n        `Missing Dexie-related metadata in Y.Doc. Documents need to be obtained through Y.Doc properties from dexie queries.`\n      );\n    }\n    // This doc is from Dexie\n    if (!db.table(parentTable) || !db.table(updatesTable)) {\n      throw new Error(\n        `Table ${parentTable} or ${updatesTable} not found in db`\n      );\n    }\n    throwIfDestroyed(doc);\n    this.stopObserving = observeYDocUpdates(\n      this,\n      doc,\n      db,\n      parentTable,\n      updatesTable,\n      parentId\n    );\n    DexieYProvider.on(\"new\").fire(this); // Allow for addons to invoke their sync- and awareness providers here.\n  }\n\n  destroy() {\n    console.debug(`Y.Doc ${this.doc?.meta?.parentId} was destroyed`);\n    wm.delete(this.doc);\n    this.doc = null;\n    this.destroyed = true;\n    this.refCount = 0;\n    this.stopObserving?.();\n    this.on = createEvents(); // Releases listeners for GC\n    this.cleanupHandlers.forEach((cleanup) => cleanup());\n  }\n\n  addCleanupHandler(cleanupHandler: (() => void) | Unsubscribable) {\n    this.cleanupHandlers.push(\n      typeof cleanupHandler === 'function'\n        ? cleanupHandler\n        : () => cleanupHandler.unsubscribe()\n    );\n  }\n}\n\n//\n// Support `using DexieYProvider.load();` syntax\n//\n// Extend DexieYProvider with Disposable interface if Symbol.dispose is supported.\n// (At runtime, this[Symbol.dispose] is created in the constructor, so we indeed implement Disposable interface)\ninterface DexieYProvider extends Disposable {}\n\n//\n// Eliminate dual package hazard \n//\n// Since we're holding static state, make sure to singletonize DexieYProvider\n//\nif (Dexie[\"DexieYProvider\"]) {\n  // @ts-ignore\n  DexieYProvider = Dexie[\"DexieYProvider\"] || DexieYProvider;\n} else {\n  Dexie[\"DexieYProvider\"] = DexieYProvider;\n}\n\nexport { DexieYProvider };\n","import { DbSchema, Dexie, ExtendableVersion, IndexSpec, TableSchema } from 'dexie';\nimport { createYjsMiddleware } from './createYjsMiddleware';\nimport { createYDocProperty } from './createYDocProperty';\nimport { periodicGC } from './periodicGC';\n\nconst YJS_MIDDLEWARE_NAME = 'yjsMiddleware';\n\nexport interface YDexieOptions {\n  gc?: boolean; // Enable or disable garbage collection for Y.js documents.\n}\n\nexport { compressYDocs } from './compressYDocs';\nexport { DexieYProvider } from './DexieYProvider';\nexport * from './types';\n\nexport default function yDexie(dbOrOptions: Dexie | YDexieOptions) {\n  // This function is a placeholder for the y-dexie addon.\n  // It can be used to initialize or configure the addon as needed.\n  if (!('transaction' in dbOrOptions)) {\n    // If db is an options object, create a configured yDexie addon that\n    // could be passed to the addons array of Dexie constructor.\n    const options = dbOrOptions;\n    // Return a configured Dexie addon function.\n    return (db: Dexie) => configurableYDexie(db, options);\n  } else {\n    // If db is a Dexie instance, it is being called as an addon.\n    // Do default configuration.\n    return configurableYDexie(dbOrOptions, {});\n  }\n}\n\nfunction configurableYDexie(db: Dexie, options: YDexieOptions) {\n  db.Table = class Table extends (db.Table as (new() => Dexie.Table<any>)) {\n    mapToClass(constructor: Function) {\n      if (this.schema.yProps) {\n        constructor = class extends (constructor as any) {};\n        this.schema.yProps.forEach(({prop, updatesTable}) => {\n          Object.defineProperty(constructor.prototype, prop, createYDocProperty(db, this, prop, updatesTable));\n        });\n      }\n      const result = super.mapToClass(constructor);\n      this.schema.mappedClass = constructor; // Also done in super.mapToClass but we need to set the user-provided class, not our altered class.\n      return result;\n    }\n  };\n\n  db.Version = class Version extends (db.Version as (new() => ExtendableVersion)) {\n    _createTableSchema(\n      name: string,\n      primKey: IndexSpec,\n      indexes: IndexSpec[]\n    ): TableSchema {\n      const yProps = indexes.filter(\n        (idx) => idx.type === 'Y' || idx.type === 'Y.Doc'\n      );\n      indexes = indexes.filter((idx) => !yProps.includes(idx)); // Y marks just the Y.Doc type and is not an index\n      const tableSchema = super._createTableSchema(\n        name,\n        primKey,\n        indexes\n      ) as TableSchema;\n      if (yProps.length > 0) {\n        tableSchema.yProps = yProps.map((idx) => ({\n          prop: idx.name,\n          updatesTable: `$${name}.${idx.name}_updates`,\n        }));\n      }\n      return tableSchema;\n    }\n\n    _parseStoresSpec(\n      stores: { [tableName: string]: string | null },\n      outSchema: DbSchema\n    ): void {\n      // Implementation for parsing stores spec\n      // This is a placeholder; actual implementation would go here\n      super._parseStoresSpec(stores, outSchema);\n\n      // Generate update tables for Y.js properties\n      Object.keys(stores).forEach((tableName) => {\n        const tblSchema = outSchema[tableName];\n        if (tblSchema) {\n          for (const yProp of tblSchema.yProps || []) {\n            super._parseStoresSpec(\n              // Add a table for each yProp containing document updates.\n              // See interface YUpdateRow { i: number, k: IndexableType, u: Uint8Array, f?: number}\n              // where\n              //   i is the auto-incremented primary key of the update table,\n              //   k is the primary key from the other table holding the document in a property.\n              //   u is the update data from Y.js\n              //   f is a flag indicating if the update comes from this client or another.\n              // Index use cases:\n              //   * Load entire document: Use index k\n              //   * After object load, observe updates on a certain document since a given revision: Use index k or i since [k+i] is not supported before Firefox 126.\n              //   * After initial sync, observe flagged updates since a given revision: Use index i and ignore unflagged.\n              //     Could be using an index [f+i] but that wouldn't gain too much and Firefox before 126 doesnt support it.\n              //     Local updates are flagged while remote updates are not.\n              //\n              { [yProp.updatesTable]: '++i,k' },\n              outSchema\n            );\n          }\n        }\n      });\n    }\n\n    stores(schema: { [tableName: string]: string | null }) {\n      const db = this.db as Dexie;\n      // This method is used to define the schema for the database.\n      // It allows you to specify the tables and their indexes.\n      const result = super.stores(schema);\n      const dbschema = db._dbSchema;\n      Object.keys(dbschema).forEach((tableName) => {\n        if (dbschema[tableName].yProps) {\n          // If a table as yProps, make sure to derive a class with generated Y properties.\n          // This is done in the mapToClass method. In case user has called mapToClass already, respect mappedClass,\n          // otherwise use Object as default to create a top-level class with the generated y properties.\n          db.table(tableName).mapToClass(\n            dbschema[tableName].mappedClass || Object\n          );\n        }\n      });\n      if (Object.values(dbschema).some((table) => table.yProps)) {\n        db.use({\n          stack: 'dbcore',\n          name: YJS_MIDDLEWARE_NAME,\n          level: 50,\n          create: createYjsMiddleware(dbschema),\n        });\n      } else {\n        db.unuse({ stack: 'dbcore', name: YJS_MIDDLEWARE_NAME });\n      }\n\n      return result;\n    }\n  };\n\n  if (options?.gc !== false) {\n    periodicGC(db);\n  }\n}\n"],"names":[],"mappings":"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"}