import e,{PropModification as t,cmp as n,RangeSet as r,liveQuery as o}from"dexie";import{Observable as s,BehaviorSubject as i,firstValueFrom as a,Subject as l,from as c,filter as u,of as d,fromEvent as f,merge as p,switchMap as y,tap as h,mergeMap as m,Subscription as v,throwError as b,combineLatest as g,map as _,share as w,timer as k,startWith as S}from"rxjs";import{filter as x,switchMap as I,delay as E,distinctUntilChanged as O,map as C,tap as j,take as T,catchError as U,debounceTime as P,startWith as A,skip as $}from"rxjs/operators";import{Encoder as D,writeVarString as L,writeAny as R,writeVarUint8Array as N,writeBigUint64 as B,toUint8Array as M}from"lib0/encoding";import{Decoder as W,readVarString as F,readAny as K,readVarUint8Array as H,readBigUint64 as V,hasContent as z,readUint8 as J}from"lib0/decoding";import*as q from"yjs";import{DexieYProvider as G}from"y-dexie";import*as Y from"y-protocols/awareness";function Z(e,t,n,r){return new(n||(n=Promise))(function(o,s){function i(e){try{l(r.next(e))}catch(e){s(e)}}function a(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}l((r=r.apply(e,t||[])).next())})}function X(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Q(e){return this instanceof Q?(this.v=e,this):new Q(e)}function ee(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,o=n.apply(e,t||[]),s=[];return r=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),i("next"),i("throw"),i("return",function(e){return function(t){return Promise.resolve(t).then(e,c)}}),r[Symbol.asyncIterator]=function(){return this},r;function i(e,t){o[e]&&(r[e]=function(t){return new Promise(function(n,r){s.push([e,t,n,r])>1||a(e,t)})},t&&(r[e]=t(r[e])))}function a(e,t){try{!function(e){e.value instanceof Q?Promise.resolve(e.value.v).then(l,c):u(s[0][2],e)}(o[e](t))}catch(e){u(s[0][3],e)}}function l(e){a("next",e)}function c(e){a("throw",e)}function u(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}function te(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=X(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise(function(r,o){(function(e,t,n,r){Promise.resolve(r).then(function(t){e({value:t,done:n})},t)})(r,o,(t=e[n](t)).done,t.value)})}}}"function"==typeof SuppressedError&&SuppressedError;const ne={userId:"unauthorized",name:"Unauthorized",claims:{sub:"unauthorized"},lastLogin:new Date(0)};try{Object.freeze(ne),Object.freeze(ne.claims)}catch(e){}const re={},oe="undefined"!=typeof self&&self.document&&"undefined"!=typeof navigator&&navigator.serviceWorker;oe&&oe.ready.then(e=>re.registration=e),"undefined"!=typeof self&&"clients"in self&&!self.document&&addEventListener("message",e=>{var t,n;(null===(n=null===(t=e.data)||void 0===t?void 0:t.type)||void 0===n?void 0:n.startsWith("sw-broadcast-"))&&[...self.clients.matchAll({includeUncontrolled:!0})].forEach(t=>{var n;return t.id!==(null===(n=e.source)||void 0===n?void 0:n.id)&&t.postMessage(e.data)})});class se{constructor(e){this.name=e}subscribe(e){if(!oe)return()=>{};const t=t=>{var n;(null===(n=t.data)||void 0===n?void 0:n.type)===`sw-broadcast-${this.name}`&&e(t.data.message)};return oe.addEventListener("message",t),()=>oe.removeEventListener("message",t)}postMessage(e){var t;"object"==typeof self.clients?[...self.clients.matchAll({includeUncontrolled:!0})].forEach(t=>t.postMessage({type:`sw-broadcast-${this.name}`,message:e})):re.registration&&(null===(t=re.registration.active)||void 0===t||t.postMessage({type:`sw-broadcast-${this.name}`,message:e}))}}const ie=globalThis["lbc-events"]||(globalThis["lbc-events"]=new Map);class ae extends s{constructor(e){const t="undefined"==typeof BroadcastChannel?new se(e):new BroadcastChannel(e);super(n=>{function r(e){n.next(e.detail)}function o(e){n.next(e.data)}let s;!function(e,t){ie.has(e)?ie.get(e).push(t):ie.set(e,[t])}(`lbc-${e}`,r);try{t instanceof se?s=t.subscribe(e=>n.next(e)):t.addEventListener("message",o)}catch(e){}return()=>{!function(e,t){const n=ie.get(e);if(n){const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}(`lbc-${e}`,r),t instanceof se?s():t.removeEventListener("message",o)}}),this.name=e,this.bc=t}next(e){this.bc.postMessage(e);!function(e){const t=ie.get(e.type);t&&t.forEach(t=>{try{t(e)}catch(e){}})}(new CustomEvent(`lbc-${this.name}`,{detail:e}))}}let le=!1;function ce(e,t){return Z(this,void 0,void 0,function*(){try{const n=yield navigator.serviceWorker.ready;if("push"===t&&n.sync&&(yield n.sync.register(`dexie-cloud:${e.name}`)),!n.active)throw new Error("Failed to trigger sync - there's no active service worker");return void n.active.postMessage({type:"dexie-cloud-sync",dbName:e.name,purpose:t})}catch(e){le||(le=!0)}})}function ue(e,t){e.cloud.usingServiceWorker?ce(e,t):e.localSyncEvent.next({purpose:t})}const de="fromBase64"in Uint8Array,fe="toBase64"in Uint8Array.prototype,pe="undefined"!=typeof Buffer?e=>Buffer.from(e,"base64"):de?e=>Uint8Array.fromBase64(e):e=>{const t=atob(e),n=t.length,r=new Uint8Array(n);for(var o=0;o<n;o++)r[o]=t.charCodeAt(o);return r},ye="undefined"!=typeof Buffer?e=>ArrayBuffer.isView(e)?Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"):Buffer.from(e).toString("base64"):fe?e=>(ArrayBuffer.isView(e)?e:new Uint8Array(e)).toBase64():e=>{const t=ArrayBuffer.isView(e)?e:new Uint8Array(e),n=[];for(let e=0,r=t.length;e<r;e+=4096){const r=t.subarray(e,e+4096);n.push(String.fromCharCode.apply(null,r))}return btoa(n.join(""))};function he(e){return Z(this,arguments,void 0,function*({realms:e,inviteRealms:t}){const n=JSON.stringify([...e.map(e=>({realmId:e,accepted:!0})),...t.map(e=>({realmId:e,accepted:!1}))].sort((e,t)=>e.realmId<t.realmId?-1:e.realmId>t.realmId?1:0)),r=(new TextEncoder).encode(n),o=yield crypto.subtle.digest("SHA-1",r);return ye(o)})}function me(e){return Object.entries(e.cloud.schema||{}).filter(([,{markedForSync:e}])=>e).map(([t])=>e.tables.filter(({name:e})=>e===t)[0]).filter(e=>e)}function ve(e){return`$${e}_mutations`}function be(e){var t;const n=null===(t=/^\$(.*)_mutations$/.exec(e))||void 0===t?void 0:t[1];if(!n)throw new Error(`Given mutationTable ${e} is not correct`);return n}const ge=[].concat;function _e(e){return ge.apply([],e)}function we(e,t){return Z(this,arguments,void 0,function*(e,t,{since:n={},limit:r=1/0}={}){const o=yield Promise.all(e.map(e=>Z(this,void 0,void 0,function*(){const t=be(e.name),o=n[t];let s=o?e.where("rev").above(o):e;r<1/0&&(s=s.limit(r));let i=yield s.toArray();i=function(e){return e=e.map(e=>{if("modify"===e.type&&null===e.criteria.index){const t=Object.assign(Object.assign({},e),{criteria:void 0,changeSpec:void 0,type:"update",keys:e.keys,changeSpecs:[e.changeSpec]});return delete t.criteria,delete t.changeSpec,t}return e}),e}(i),i=function(e){const t=new Map;for(const n of e)if("update"===n.type){if(1!==n.keys.length||1!==n.changeSpecs.length)continue;const e=""+n.keys[0],r=n.changeSpecs[0];if(Object.values(r).some(e=>"object"==typeof e&&e&&"@@propmod"in e))continue;let o=t.get(e);o?o.push({txid:n.txid,updateSpec:r}):t.set(e,[{txid:n.txid,updateSpec:r}])}return e=e.filter(e=>{if("update"!==e.type)return!0;if(1!==e.keys.length||1!==e.changeSpecs.length)return!0;const n=e.changeSpecs[0];if(Object.values(n).some(e=>"object"==typeof e&&e&&"@@propmod"in e))return!0;const r=new Set(Object.keys(e.changeSpecs[0])),o=""+e.keys[0],s=t.get(o);if(!s)return!0;for(let t=s.length-1;t>=0;--t){const{txid:n,updateSpec:o}=s[t];if(n===e.txid)break;for(const e of Object.keys(o))r.delete(e)}return 0!==r.size}),e}(i);return i.map(e=>({table:t,mut:e}))}))),s=_e(o).sort((e,t)=>e.mut.txid===t.mut.txid?e.mut.opNo-t.mut.opNo:e.mut.ts-t.mut.ts),i=[];let a=null,l=null;for(const{table:e,mut:t}of s)a&&a.table===e&&l===t.txid?a.muts.push(t):(a={table:e,muts:[t]},l=t.txid,i.push(a));return i})}function ke(e){const t=new Uint8Array(e);if("undefined"!=typeof crypto)crypto.getRandomValues(t);else for(let n=0;n<e;n++)t[n]=Math.floor(256*Math.random());if("undefined"!=typeof Buffer&&Buffer.from)return Buffer.from(t).toString("base64");if("undefined"!=typeof btoa)return btoa(String.fromCharCode.apply(null,t));throw new Error("No btoa or Buffer available")}const Se={}.hasOwnProperty;function xe(e,t,n){if(e&&void 0!==t&&(!("isFrozen"in Object)||!Object.isFrozen(e)))if("string"!=typeof t&&"length"in t){!function(e){if(!e)throw new Error("Assertion Failed")}("string"!=typeof n&&"length"in n);for(var r=0,o=t.length;r<o;++r)xe(e,t[r],n[r])}else{var s=t.indexOf(".");if(-1!==s){var i=t.substr(0,s),a=t.substr(s+1);if(""===a)void 0===n?Array.isArray(e)?isNaN(parseInt(i))||e.splice(parseInt(i),1):delete e[i]:e[i]=n;else{var l=e[i];l&&function(e,t){return Se.call(e,t)}(e,i)||(l=e[i]={}),xe(l,a,n)}}else void 0===n?Array.isArray(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}const Ie="undefined"!=typeof self&&"undefined"!=typeof crypto?(e,t=crypto.getRandomValues.bind(crypto))=>{const n=new Uint8Array(e);return t(n),self.btoa(String.fromCharCode.apply(null,n))}:"undefined"!=typeof Buffer?(e,t=Ee)=>{const n=Buffer.alloc(e);return t(n),n.toString("base64")}:()=>{throw new Error("No implementation of randomString was found")};function Ee(e){for(let t=0;t<e.length;++t)e[t]=Math.floor(256*Math.random())}function Oe(e){return"string"==typeof e||!!(Array.isArray(e)&&e.some(e=>Oe(e))&&e.every(Ce))}function Ce(e){return"string"==typeof e||"number"==typeof e||Array.isArray(e)&&e.every(Ce)}function je(e,t,n){const r=e[t]||(e[t]={}),o=n.keys.map(e=>"string"==typeof e?e:JSON.stringify(e));switch(n.type){case"insert":case"upsert":o.forEach((e,t)=>{r[e]={type:"ups",val:n.values[t]}});break;case"update":case"modify":o.forEach((e,t)=>{const o="update"===n.type?n.changeSpecs[t]:n.changeSpec,s=r[e];if(s)switch(s.type){case"ups":for(const[e,t]of Object.entries(o))xe(s.val,e,t);break;case"del":break;case"upd":Object.assign(s.mod,o)}else r[e]={type:"upd",mod:o}});break;case"delete":o.forEach(e=>{r[e]={type:"del"}})}return e}function Te(e,t){for(const{table:n,muts:r}of t)for(const t of r)je(e,n,t)}async function*Ue(e){let t=0,n=new Uint8Array(4),r=0,o=[],s=0;for await(const i of e){const e=new DataView(i.buffer,i.byteOffset,i.byteLength);let a=0;for(;a<i.byteLength;)switch(t){case 0:if(a+4>i.byteLength){for(const e of i.slice(a)){if(4===r)break;n[r++]=e,++a}if(r<4)break}else if(r>0&&r<4)for(const e of i.slice(a,a+4-r))n[r++]=e,++a;case 1:s=4===r?new DataView(n.buffer,0,4).getUint32(0,!1):e.getUint32(a,!1),r?r=0:a+=4;case 2:if(a>=i.byteLength){t=2;break}if(a+s>i.byteLength)o.push(i.slice(a)),s-=i.byteLength-a,t=2,a=i.byteLength;else{if(o.length>0){const e=new Uint8Array(o.reduce((e,t)=>e+t.byteLength,s));let t=0;for(const n of o)e.set(n,t),t+=n.byteLength;e.set(i.slice(a,a+s),t),o=[],yield e}else yield i.slice(a,a+s);a+=s,t=0}}}}class Pe extends Error{constructor({title:e,message:t,messageCode:n,messageParams:r}){super(t),this.name="TokenErrorResponseError",this.title=e,this.messageCode=n,this.messageParams=r}}function Ae(t,n){return new Promise((r,o)=>{const s=Object.assign(Object.assign({submitLabel:"Submit",cancelLabel:"Cancel"},n),{onSubmit:e=>{t.next(void 0),r(e)},onCancel:()=>{t.next(void 0),o(new e.AbortError("User cancelled"))}});t.next(s)})}function $e(e,t,...n){return Ae(e,{type:"message-alert",title:t,alerts:n,fields:{},submitLabel:"OK",cancelLabel:null})}function De(e,t,n){return Z(this,void 0,void 0,function*(){let r=n||"";for(;!r||!/^[\w-+.]+@([\w-]+\.)+[\w-]{2,10}(\sas\s[\w-+.]+@([\w-]+\.)+[\w-]{2,10})?$/.test(r);)r=(yield Ae(e,{type:"email",title:t,alerts:r?[{type:"error",messageCode:"INVALID_EMAIL",message:"Please enter a valid email address",messageParams:{}}]:[],fields:{email:{type:"email",placeholder:"you@somedomain.com"}}})).email;return r})}function Le(e,t,n){return Z(this,void 0,void 0,function*(){const r=[{type:"info",messageCode:"OTP_SENT",message:"A One-Time password has been sent to {email}",messageParams:{email:t}}];n&&r.push(n);const{otp:o}=yield Ae(e,{type:"otp",title:"Enter OTP",alerts:r,fields:{otp:{type:"otp",label:"OTP",placeholder:"Paste OTP here"}}});return o})}function Re(e){return Z(this,void 0,void 0,function*(){var t,n,r;const o=yield e.getCurrentUser(),{accessToken:s,accessTokenExpiration:i,refreshToken:a,refreshTokenExpiration:l,claims:c}=o;if(!s)return null;if((null!==(t=null==i?void 0:i.getTime())&&void 0!==t?t:1/0)>Date.now()&&"ok"===((null===(n=o.license)||void 0===n?void 0:n.status)||"ok"))return o;if(!a)throw new Error("Refresh token missing");if((null!==(r=null==l?void 0:l.getTime())&&void 0!==r?r:1/0)<=Date.now())throw new Error("Refresh token has expired");const u=yield Be(e.cloud.options.databaseUrl,o);return yield e.table("$logins").update(c.sub,{accessToken:u.accessToken,accessTokenExpiration:u.accessTokenExpiration,claims:u.claims,license:u.license,data:u.data}),u})}function Ne(t,n,r,o,s){return Z(this,void 0,void 0,function*(){return n.accessToken&&n.accessTokenExpiration.getTime()>Date.now()?n:n.refreshToken&&(!n.refreshTokenExpiration||n.refreshTokenExpiration.getTime()>Date.now())?yield Be(t,n):yield function(t,n,r,o){return Z(this,void 0,void 0,function*(){if(!crypto.subtle)throw"undefined"!=typeof location&&"http:"===location.protocol?new Error("Dexie Cloud Addon needs to use WebCrypto, but your browser has disabled it due to being served from an insecure location. Please serve it from https or http://localhost:<port> (See https://stackoverflow.com/questions/46670556/how-to-enable-crypto-subtle-for-unsecure-origins-in-chrome/46671627#46671627)"):new Error("This browser does not support WebCrypto.");const{privateKey:s,publicKey:i}=yield crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!1,["sign","verify"]);if(!s||!i)throw new Error("Could not generate RSA keypair");t.nonExportablePrivateKey=s;const a=function(e){const t=ye(e);return function(e){let t="-----BEGIN PUBLIC KEY-----\n";for(;e.length>0;)t+=e.substring(0,64)+"\n",e=e.substring(64);return t+="-----END PUBLIC KEY-----",t}(t)}(yield crypto.subtle.exportKey("spki",i));t.publicKey=i;try{const e=yield n({public_key:a,hints:o});if("error"===e.type)throw new Pe(e);if("tokens"!==e.type)throw new Error(`Unexpected response type from token endpoint: ${e.type}`);return t.accessToken=e.accessToken,t.accessTokenExpiration=new Date(e.accessTokenExpiration),t.refreshToken=e.refreshToken,e.refreshTokenExpiration&&(t.refreshTokenExpiration=new Date(e.refreshTokenExpiration)),t.userId=e.claims.sub,t.email=e.claims.email,t.name=e.claims.name,t.claims=e.claims,t.license={type:e.userType,status:e.claims.license||"ok"},t.data=e.data,null!=e.evalDaysLeft&&(t.license.evalDaysLeft=e.evalDaysLeft),null!=e.userValidUntil&&(t.license.validUntil=new Date(e.userValidUntil)),e.alerts&&e.alerts.length>0&&(yield Ae(r,{type:"message-alert",title:"Authentication Alert",fields:{},alerts:e.alerts})),t}catch(t){if(t instanceof Pe)throw yield $e(r,t.title,{type:"error",messageCode:t.messageCode,message:t.message,messageParams:{}}),t;let n="We're having a problem authenticating right now.";if(t instanceof TypeError){n=void 0!==typeof navigator&&!navigator.onLine?"You seem to be offline. Please connect to the internet and try again.":e.debug||"undefined"!=typeof location&&("localhost"===location.hostname||"127.0.0.1"===location.hostname)?`Could not connect to server. Please verify that your origin '${location.origin}' is whitelisted using \`npx dexie-cloud whitelist\``:"Could not connect to server. Please verify the connection.",yield $e(r,"Authentication Failed",{type:"error",messageCode:"GENERIC_ERROR",message:n,messageParams:{}}).catch(()=>{})}throw t}})}(n,r,o,s)})}function Be(e,t){return Z(this,void 0,void 0,function*(){if(!t.refreshToken)throw new Error("Cannot refresh token - refresh token is missing.");if(!t.nonExportablePrivateKey)throw new Error("login.nonExportablePrivateKey is missing - cannot sign refresh token without a private key.");const n=Date.now(),r="RSASSA-PKCS1-v1_5",o=(new TextEncoder).encode(t.refreshToken+n),s=yield crypto.subtle.sign(r,t.nonExportablePrivateKey,o),i=ye(s),a={grant_type:"refresh_token",refresh_token:t.refreshToken,scopes:["ACCESS_DB"],signature:i,signing_algorithm:r,time_stamp:n},l=yield fetch(`${e}/token`,{body:JSON.stringify(a),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"});if(200!==l.status)throw new Error(`RefreshToken: Status ${l.status} from ${e}/token`);const c=yield l.json();if("error"===c.type)throw new Pe(c);return t.accessToken=c.accessToken,t.accessTokenExpiration=c.accessTokenExpiration?new Date(c.accessTokenExpiration):void 0,t.claims=c.claims,t.license={type:c.userType,status:c.claims.license||"ok"},null!=c.evalDaysLeft&&(t.license.evalDaysLeft=c.evalDaysLeft),null!=c.userValidUntil&&(t.license.validUntil=new Date(c.userValidUntil)),c.data&&(t.data=c.data),t})}const{toString:Me}={};const We={replace:function(e){const t=Object.keys(e);let n=null;for(let e=0,r=t.length;e<r;++e)"$"===t[e][0]&&(n=n||[],n.push(t[e]));if(!n)return e;const r={...e};for(const e of n)delete r[e];for(const t of n)r["$"+t]=e[t];return r}};function Fe(...e){const t=e.reduce((e,t)=>({...e,...t}),e.reduce((e,t)=>({...t,...e}),{})),n=new WeakMap;return{stringify(e,r,o){const s=JSON.stringify(e,function(e){const o=this[e],s=function(e){const r=typeof e;switch(typeof e){case"object":case"function":{if(null===e)return null;const r=Object.getPrototypeOf(e);if(!r)return We;let s=n.get(r);if(void 0!==s)return s;const i=(o=e,Me.call(o).slice(8,-1)),a=Object.entries(t).find(([t,n])=>{var r,o;return null!==(o=null===(r=null==n?void 0:n.test)||void 0===r?void 0:r.call(n,e,i))&&void 0!==o?o:t===i});return s=null==a?void 0:a[1],s||(s=Array.isArray(e)?null:"function"==typeof e?t.function||null:We),n.set(r,s),s}default:return t[r]}var o}(o);return s?s.replace(o,r,t):o},o);return s},parse(e,n){const r=[];return JSON.parse(e,function(e,o){const s=null==o?void 0:o.$t;if(s){const e=t[s];o=e?e.revive(o,n,t):o}let i=r[r.length-1];if(i&&i[0]===o){o={...o};for(const e of i[1])delete o[e];for(const[e,t]of Object.entries(i[2]))o[e]=t;r.pop()}if(void 0===o||"$"===e[0]&&"$t"!==e){let t,n;i=r[r.length-1],i&&i[0]===this?(t=i[1],n=i[2]):r.push([this,t=[],n={}]),"$"===e[0]&&"$t"!==e?(t.push(e),n[e.substr(1)]=o):n[e]=void 0}return o})}}}const Ke={Blob:{test:(e,t)=>"Blob"===t,replace:(e,t)=>{const n=t.length;return t.push(e),{$t:"Blob",mimeType:e.type,i:n}},revive:({i:e,mimeType:t},n)=>new Blob([n[e]],{type:t})}};var He={number:{replace:e=>{switch(!0){case isNaN(e):return{$t:"number",v:"NaN"};case e===1/0:return{$t:"number",v:"Infinity"};case e===-1/0:return{$t:"number",v:"-Infinity"};default:return e}},revive:({v:e})=>Number(e)}};const Ve={bigint:{replace:e=>({$t:"bigint",v:""+e}),revive:e=>BigInt(e.v)}};var ze={Date:{replace:e=>({$t:"Date",v:isNaN(e.getTime())?"NaN":e.toISOString()}),revive:({v:e})=>new Date("NaN"===e?NaN:Date.parse(e))}},Je={Set:{replace:e=>({$t:"Set",v:Array.from(e.entries())}),revive:({v:e})=>new Set(e)}},qe={Map:{replace:e=>({$t:"Map",v:Array.from(e.entries())}),revive:({v:e})=>new Map(e)}};const Ge="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof global?global:void 0;var Ye=["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","DataView","BigInt64Array","BigUint64Array"].reduce((e,t)=>({...e,[t]:{replace:(e,n,r)=>({$t:t,v:r.ArrayBuffer.replace(0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength),n,r).v}),revive:({v:e},n,r)=>{const o=Ge[t];return o&&new o(r.ArrayBuffer.revive({v:e},n,r))}}}),{});function Ze(e){return function(e){for(var t="",n=0,r=e.length;n<r;n++)t+=et[e[n]];return t}(ye(e))}function Xe(e){return pe(function(e){if("string"!=typeof e)throw new Error("invalid decoder input: "+e);for(var t="",n=0,r=e.length;n<r;n++)t+=Qe[e[n]];return t}(e))}const Qe={"-":"=",0:"A",1:"B",2:"C",3:"D",4:"E",5:"F",6:"G",7:"H",8:"I",9:"J",A:"K",B:"L",C:"M",D:"N",E:"O",F:"P",G:"Q",H:"R",I:"S",J:"T",K:"U",L:"V",M:"W",N:"X",O:"Y",P:"Z",Q:"a",R:"b",S:"c",T:"d",U:"e",V:"f",W:"g",X:"h",Y:"i",Z:"j",_:"k",a:"l",b:"m",c:"n",d:"o",e:"p",f:"q",g:"r",h:"s",i:"t",j:"u",k:"v",l:"w",m:"x",n:"y",o:"z",p:"0",q:"1",r:"2",s:"3",t:"4",u:"5",v:"6",w:"7",x:"8",y:"9",z:"+","|":"/"},et={};for(const e of Object.keys(Qe))et[Qe[e]]=e;var tt={ArrayBuffer:{replace:e=>({$t:"ArrayBuffer",v:Ze(e)}),revive:({v:e})=>{const t=Xe(e);return t.buffer.byteLength===t.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}}};class nt{constructor(e,t){this.buf=e,this.type=t}}function rt(e){const t=new XMLHttpRequest;if(t.overrideMimeType("text/plain; charset=x-user-defined"),t.open("GET",URL.createObjectURL(e),!1),t.send(),200!==t.status&&0!==t.status)throw new Error("Bad Blob access: "+t.status);return t.responseText}function ot(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t.buffer}var st={Blob:{test:(e,t)=>"Blob"===t||e instanceof nt,replace:e=>({$t:"Blob",v:ye(e instanceof nt?e.buf:ot(rt(e))),type:e.type}),revive:({type:e,v:t})=>{const n=pe(t);return void 0!==typeof Blob?new Blob([n]):new nt(n.buffer,e)}}};const it={...He,...Ve,...ze,...Je,...qe,...Ye,...tt,...st};function at(e){return new Promise((t,n)=>{const r=new FileReader;r.onabort=e=>n(new Error("file read aborted")),r.onerror=e=>n(e.target.error),r.onload=e=>t(e.target.result),r.readAsArrayBuffer(e)})}var lt={undefined:{replace:()=>({$t:"undefined"}),revive:()=>{}}},ct={File:{test:(e,t)=>"File"===t,replace:e=>({$t:"File",v:ye(ot(rt(e))),type:e.type,name:e.name,lastModified:new Date(e.lastModified).toISOString()}),revive:({type:e,v:t,name:n,lastModified:r})=>{const o=pe(t);return new File([o],n,{type:e,lastModified:new Date(r).getTime()})}}};const ut="function"==typeof BigInt&&"bigint"==typeof BigInt(0);class dt{toString(){return this.v}constructor(e){this.v=e}}const ft=ut?{}:{bigint:{test:e=>e instanceof dt,replace:e=>Object.assign({$t:"bigint"},e),revive:({v:e})=>new dt(e)}},pt=Object.assign(Object.assign(Object.assign(Object.assign({},lt),ft),ct),{PropModification:{test:e=>e instanceof t,replace:e=>Object.assign({$t:"PropModification"},e["@@propmod"]),revive:e=>{var{$t:n}=e,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(e,["$t"]);return new t(r)}}}),yt=Fe(it,pt),ht=function(...e){const t=Fe(it,Ke,...e);return{toBinary(e){const[t,n]=this.stringify(e),r=new ArrayBuffer(4);return new DataView(r).setUint32(0,t.size),new Blob([r,t,n])},stringify(e){const n=[],r=t.stringify(e,n);return[new Blob(n.map(e=>{const t=new ArrayBuffer(4);return new DataView(t).setUint32(0,"byteLength"in e?e.byteLength:e.size),new Blob([t,e])})),r]},async parse(e,n){let r=0;const o=[],s=await at(n),i=new DataView(s);for(;r<s.byteLength;){const e=i.getUint32(r);r+=4;const t=s.slice(r,r+e);r+=e,o.push(t)}return t.parse(e,o)},async fromBinary(e){const t=new DataView(await at(e.slice(0,4))).getUint32(0),n=e.slice(4,t+4),r=await function(e){return new Promise((t,n)=>{const r=new FileReader;r.onabort=e=>n(new Error("file read aborted")),r.onerror=e=>n(e.target.error),r.onload=e=>t(e.target.result),r.readAsText(e)})}(e.slice(t+4));return await this.parse(r,n)}}}(pt);class mt extends Error{constructor(e,t){super(t||`${e.status} ${e.statusText}`),this.httpStatus=e.status}get name(){return"HttpError"}}function vt(t,n,r){const o=[];for(let s of r){const{table:r,muts:i}=s,a=t.tables.find(e=>e.name===r);if(!a)throw new Error(`Internal error: table ${r} not found in DBCore schema`);const{primaryKey:l}=a;let c=s;i.forEach((t,r)=>{const o=!l.outbound&&("upsert"===t.type||"insert"===t.type);t.keys.forEach((t,i)=>{if(Array.isArray(t)){c===s&&(c=bt(s,o));const e=c.muts[r],n=JSON.stringify(t);e.keys[i]=n}else if("#"===t[0]){c===s&&(c=bt(s,o));const a=c.muts[r];if(!n.isLoggedIn)throw new Error("Internal error: Cannot sync private IDs before authenticated");const u=`${t}:${n.userId}`;a.keys[i]=u,o&&e.setByKeyPath(a.values[i],l.keyPath,u)}})}),o.push(c)}return o}function bt(e,t){return Object.assign(Object.assign({},e),{muts:t?e.muts.map(e=>"insert"!==e.type&&"upsert"!==e.type||!e.values?Object.assign(Object.assign({},e),{keys:e.keys.slice()}):Object.assign(Object.assign({},e),{keys:e.keys.slice(),values:e.values.slice()})):e.muts.map(e=>Object.assign(Object.assign({},e),{keys:e.keys.slice()}))})}let gt=new WeakMap;function _t(e){return Z(this,void 0,void 0,function*(){var t,n;const r=(null!==(n=null===(t=gt.get(e))||void 0===t?void 0:t.getTime())&&void 0!==n?n:0)-Date.now();r>0&&(yield new Promise(e=>setTimeout(e,r)))})}function wt(e,t,n,r,o,s,i,a,l){return Z(this,void 0,void 0,function*(){const c={Accept:"application/json, application/x-bison, application/x-bison-stream","Content-Type":"application/tson"},u=yield Re(o),d=null==u?void 0:u.accessToken;d&&(c.Authorization=`Bearer ${d}`);const f={v:2,dbID:null==n?void 0:n.remoteDbId,clientIdentity:a,schema:i||{},lastPull:n?{serverRevision:n.serverRevision,yServerRevision:n.yServerRevision,realms:n.realms,inviteRealms:n.inviteRealms}:void 0,baseRevs:r,changes:vt(o.dx.core.schema,l,e),y:t,dxcv:o.cloud.version};o.syncStateChangedEvent.next({phase:"pushing"});const p=yt.stringify(f),y=yield fetch(`${s}/sync`,{method:"post",headers:c,credentials:"include",body:p});if(o.syncStateChangedEvent.next({phase:"pulling"}),function(e,t){const n=t.headers.get("Ratelimit-Limit"),r=t.headers.get("Ratelimit-Remaining"),o=t.headers.get("Ratelimit-Reset");if(n&&r&&o){const t=Number(n),s=Math.max(0,Number(r)),i=Number(o);if(s<t/2){const t=Math.ceil(i/(s+1));gt.set(e,new Date(Date.now()+1e3*t))}else gt.delete(e)}}(o,y),!y.ok)throw new mt(y);if("application/x-bison"===y.headers.get("content-type"))return ht.fromBinary(yield y.blob());{const e=yield y.text();return yt.parse(e)}})}function kt(t){if(null==t?void 0:t.cancelled)throw new e.AbortError("Operation was cancelled")}let St=!1;function xt(e,t,n,r){return Z(this,void 0,void 0,function*(){yield e.$baseRevs.bulkPut(Object.keys(t).filter(e=>t[e].markedForSync).map(e=>({tableName:e,clientRev:(n[e]||0)+1,serverRev:r}))),yield e.$baseRevs.where("tableName").noneOf(Object.keys(t).filter(e=>t[e].markedForSync)).delete()})}function It(e,t={}){for(const{table:n,muts:r}of e){const e=r.length>0?r[r.length-1].rev:null;t[n]=e||t[n]||0}return t}function Et(t,r,o){return Z(this,void 0,void 0,function*(){const s=yield t.bulkGet(r),i=[],a=[];r.forEach((r,l)=>{const c=s[l];if(c){for(const[s,i]of Object.entries(o[l]))if(s===t.schema.primKey.keyPath){if(0!==n(i,r))throw new Error("Cannot change primary key")}else e.setByKeyPath(c,s,i);i.push(r),a.push(c)}}),yield null==t.schema.primKey.keyPath?t.bulkPut(a,i):t.bulkPut(a)})}function Ot(t,n){return Z(this,void 0,void 0,function*(){for(const{table:r,muts:o}of t){if(!n.dx._allTables[r])continue;const t=n.table(r),{primaryKey:s}=t.core.schema,i=e=>{switch(e[0]){case"[":if(e.endsWith("]"))try{return JSON.parse(e)}catch(e){}return e;case"#":return e.endsWith(":"+n.cloud.currentUserId)?e.substr(0,e.length-n.cloud.currentUserId.length-1):e;default:return e}};for(const n of o){const r=n.keys.map(i);switch(n.type){case"insert":s.outbound?yield t.bulkAdd(n.values,r):(r.forEach((t,r)=>{e.setByKeyPath(n.values[r],s.keyPath,t)}),yield t.bulkAdd(n.values));break;case"upsert":s.outbound?yield t.bulkPut(n.values,r):(r.forEach((t,r)=>{e.setByKeyPath(n.values[r],s.keyPath,t)}),yield t.bulkPut(n.values));break;case"modify":1===r.length?yield t.update(r[0],n.changeSpec):yield t.where(":id").anyOf(r).modify(n.changeSpec);break;case"update":yield Et(t,r,n.changeSpecs);break;case"delete":yield t.bulkDelete(r)}}}})}"undefined"!=typeof self&&"undefined"!=typeof navigator&&(St=navigator.onLine,self.addEventListener("online",()=>St=!0),self.addEventListener("offline",()=>St=!1));const Ct="dexie-cloud-syncer";function jt(e,t){return e.where("i").between(t,1/0,!0).toArray()}function Tt(e,t,n){var r,o,s;if(!e.dx._allTables[t])return;const i=null===(s=null===(o=null===(r=e.table(t))||void 0===r?void 0:r.schema.yProps)||void 0===o?void 0:o.find(e=>e.prop===n))||void 0===s?void 0:s.updatesTable;return i&&e.dx._allTables[i]?e.table(i):void 0}function Ut(e,t){return Z(this,void 0,void 0,function*(){var r;const o={};let s,i=!1;for(const a of e)try{switch(a.type){case"u-s":{const e=Tt(t,a.table,a.prop);if(e){const t={k:a.k,u:a.u};a.r&&(t.r=a.r,s=a.r),o[e.name]=yield e.add(t)}break}case"u-ack":{const e=Tt(t,a.table,a.prop);e&&(yield t.transaction("rw",e,t=>Z(this,void 0,void 0,function*(){let n=yield t.table(e.name).get(Ct);yield t.table(e.name).put(Object.assign(Object.assign({},n||{i:Ct}),{unsentFrom:Math.max((null==n?void 0:n.unsentFrom)||1,a.i+1)}))})));break}case"u-reject":{const e=Tt(t,a.table,a.prop);if(!e)break;const o=null===(r=yield e.get(a.i))||void 0===r?void 0:r.k;if(null!=o){yield t.transaction("rw",e,t=>(t.idbtrans._rejecting_y_ypdate=!0,e.where("i").aboveOrEqual(a.i).filter(e=>0===n(e.k,o)&&!(1&~(e.f||0))).delete()));const r=G.getDocCache(t.dx).find(a.table,o,a.prop);r&&r.destroy()}break}case"in-sync":{const e=G.getDocCache(t.dx).find(a.table,a.k,a.prop);e&&!e.isSynced&&e.emit("sync",[!0,e]);break}case"y-complete-sync-done":s=a.yServerRev;break;case"outdated-server-rev":i=!0}}catch(e){}return{receivedUntils:o,resyncNeeded:i,yServerRevision:s}})}function Pt(t,n,r){return Z(this,arguments,void 0,function*(t,n,{yDownloadedRealms:r,realms:o}){if(r&&o&&o.every(e=>"*"===r[e]))return;const s=yield Re(t),i={"Content-Type":"application/json",Accept:"application/octet-stream"};s&&(i.Authorization=`Bearer ${s.accessToken}`);const a=yield fetch(`${n}/y/download`,{body:yt.stringify({downloadedRealms:r||{}}),method:"POST",headers:i,credentials:"include"});if(!a.ok)throw new Error(`Failed to download Yjs documents from server. Status: ${a.status}`);yield async function(e,...t){let n=e();for(let e=0;e<t.length;e++)n=t[e](n);for await(const e of n);}(function(e){return async function*(){if(!e.body)throw new Error("Response body is not readable");const t=e.body.getReader();try{for(;;){const{done:e,value:n}=await t.read();if(e)return;yield n}}finally{t.releaseLock()}}}(a),Ue,function(r){return ee(this,arguments,function*(){var o,s,i,a;let l=null,c=null,u=null,d=[];function f(e){return Z(this,void 0,void 0,function*(){const r=d[d.length-1];if(d.length>0){if(!l||!c||!u)throw new Error(`Protocol error from ${n}/y/download`);const e=Tt(t,c,u);e&&(yield e.bulkAdd(d)),d=[]}l&&(c&&u&&r||e)&&(yield t.$syncState.update("syncState",t=>{const n=t.yDownloadedRealms||{};n[l]=e?"*":{tbl:c,prop:u,key:r.k},t.yDownloadedRealms=n}))})}try{try{for(var p,y=!0,h=te(r);!(o=(p=yield Q(h.next())).done);y=!0){a=p.value,y=!1;const e=new W(a);for(;z(e);)switch(J(e)){case 1:yield Q(f(!0)),l=F(e);break;case 2:yield Q(f(!1)),c=F(e),u=F(e);break;case 3:{const t=K(e),n=H(e);d.push({k:t,u:n});break}}yield Q(f(!1))}}catch(e){s={error:e}}finally{try{y||o||!(i=h.return)||(yield Q(i.call(h)))}finally{if(s)throw s.error}}yield Q(f(!0))}catch(t){throw t instanceof e.DexieError||(yield Q(f(!1))),t}})})})}const At="currentSyncWorker";function $t(e,t,n,r){return Dt(e,t,n,r).then(t=>((null==r?void 0:r.justCheckIfNeeded)||e.syncStateChangedEvent.next({phase:"in-sync"}),t)).catch(o=>Z(this,void 0,void 0,function*(){return(null==r?void 0:r.justCheckIfNeeded)?Promise.reject(o):St&&(null==r?void 0:r.retryImmediatelyOnFetchError)&&"TypeError"===(null==o?void 0:o.name)&&/fetch/.test(null==o?void 0:o.message)?(e.syncStateChangedEvent.next({phase:"error",error:o}),yield new Promise(e=>setTimeout(e,500)),yield $t(e,t,n,Object.assign(Object.assign({},r),{retryImmediatelyOnFetchError:!1}))):(yield e.$syncState.update("syncState",{timestamp:new Date,error:""+o}),e.syncStateChangedEvent.next({phase:St?"error":"offline",error:new Error(""+(null==o?void 0:o.message)||o)}),Promise.reject(o))}))}function Dt(e,t,n){return Z(this,arguments,void 0,function*(e,t,n,{isInitialSync:r,cancelToken:o,justCheckIfNeeded:s,purpose:i}={isInitialSync:!1}){var a;if(!(null===(a=e.cloud.options)||void 0===a?void 0:a.databaseUrl))throw new Error("Internal error: sync must not be called when no databaseUrl is configured");const{databaseUrl:l}=t,c=yield e.getCurrentUser(),u=c.isLoggedIn?me(e):[],d=u.map(t=>e.table(ve(t.name))),f=yield e.getPersistedSyncState(),p=c.isLoggedIn,y=p?function(e,t){const n=(null==t?void 0:t.syncedTables)||[];return me(e).filter(e=>!n.includes(e.name))}(e,f):[];kt(o);const h=y.length>0;if(h){if(s)return!0;yield e.transaction("rw",y,e=>Z(this,void 0,void 0,function*(){e.idbtrans.disableChangeTracking=!0,e.idbtrans.disableAccessControl=!0,yield function(e,t,n){return Z(this,void 0,void 0,function*(){const r=new Set(n||[]);for(const n of e)"members"===n.name?yield n.toCollection().modify(e=>{r.has(e.realmId)||e.userId&&e.userId!==ne.userId||(e.userId=t.userId)}):"roles"===n.name||("realms"===n.name?yield n.toCollection().modify(e=>{r.has(e.realmId)||void 0!==e.owner&&e.owner!==ne.userId||(e.owner=t.userId)}):yield n.toCollection().modify(e=>{e.realmId&&r.has(e.realmId)||(e.owner&&e.owner!==ne.userId||(e.owner=t.userId),e.realmId&&e.realmId!==ne.userId||(e.realmId=t.userId))}))})}(y,c,null==f?void 0:f.realms)})),kt(o)}const[m,v,b,{yMessages:g,lastUpdateIds:_}]=yield e.transaction("r",e.tables,()=>Z(this,void 0,void 0,function*(){const t=yield e.getPersistedSyncState();let r=yield e.$baseRevs.toArray();r=r.filter(e=>u.some(t=>t.name===e.tableName));let s=yield we(d,e);const i=yield function(e,t){return Z(this,void 0,void 0,function*(){const n=[],r={};for(const o of t)if(o.schema.yProps)for(const t of o.schema.yProps){const s=e.table(t.updatesTable),i=yield s.get(Ct),a=(null==i?void 0:i.unsentFrom)||1,l=(null==i?void 0:i.receivedUntil)||0,c=Math.min(a,l+1),u=yield jt(s,c);u.length>0&&(r[s.name]=u[u.length-1].i);const d={};for(const e of u){const t=!(1&~(e.f||0));if(t&&e.i<a)continue;const n=JSON.stringify(e.k)+"/"+t;let r=d[n];r?(r.u.push(e.u),r.i=Math.max(e.i,r.i)):(d[n]=r={i:e.i,k:e.k,isLocal:t,u:[]},r.u.push(e.u))}for(const{k:e,isLocal:r,u:s,i:i}of Object.values(d)){const a=1===s.length?s[0]:q.mergeUpdatesV2(s);if(r)n.push({type:"u-c",table:o.name,prop:t.prop,k:e,u:a,i:i});else{const r=q.encodeStateVectorFromUpdateV2(a);n.push({type:"sv",table:o.name,prop:t.prop,k:e,sv:r})}}}return{yMessages:n,lastUpdateIds:r}})}(e,u);if(kt(o),h){const e=[...(null==f?void 0:f.realms)||[],...(null==f?void 0:f.inviteRealms)||[]],a=yield function(e,t,n,r){return Z(this,void 0,void 0,function*(){const o=`upload-${ke(8)}`;if(t.isLoggedIn&&e.length>0){const s=new Set(r||[]);return(yield Promise.all(e.map(e=>Z(this,void 0,void 0,function*(){const{extractKey:r}=e.core.schema.primaryKey;if(!r)return{table:e.name,muts:[]};const i=n[e.name],a=(null==i?void 0:i.generatedGlobalId)?e.filter(e=>{return r(e),!s.has(e.realmId||"")&&(t=r(e),!(n=null==i?void 0:i.idPrefix)||"string"==typeof t&&t.startsWith(n));var t,n}):e.filter(e=>{const t=r(e);return!s.has(e.realmId||"")&&Oe(t)}),l=yield a.toArray();if(l.length>0){const n={type:"upsert",values:l,keys:l.map(r),userId:t.userId,txid:o};return{table:e.name,muts:[n]}}return{table:e.name,muts:[]}})))).filter(e=>e.muts.length>0)}return[]})}(y,c,n,e);return kt(o),s=s.concat(a),[s,t,r,i]}return[s,t,r,i]})),w=m.some(e=>e.muts.some(e=>e.keys.length>0))||g.some(e=>"u-c"===e.type);if(s)return w;if("push"===i&&!w)return!1;const k=It(m,null==v?void 0:v.latestRevisions),S=(null==v?void 0:v.clientIdentity)||Ie(16);kt(o);const x=yield wt(m,g,v,b,e,l,n,S,c),{done:I,newSyncState:E}=yield e.transaction("rw",e.tables,t=>Z(this,void 0,void 0,function*(){t.idbtrans.disableChangeTracking=!0,t.idbtrans.disableAccessControl=!0;for(const e of Object.keys(n))x.schema[e]&&(n[e]=x.schema[e]);yield e.$syncState.put(n,"schema");const r=yield we(d,e,{since:k});for(const t of d){const n=be(t.name);if(r.some(e=>e.table===n&&e.muts.length>0)){if(k[n]){const r=k[n]||0;yield Promise.all([t.where("rev").belowOrEqual(r).delete(),e.$baseRevs.where(":id").between([n,-1/0],[n,r+1],!0,!0).reverse().offset(1).delete()])}}else yield Promise.all([t.clear(),e.$baseRevs.where({tableName:n}).delete()])}It(r,k),yield xt(e,n,k,x.serverRevision);const o=yield e.getPersistedSyncState();yield function(e,t,n){return Z(this,void 0,void 0,function*(){const r=new Set,o=new Set,s=n?n.realms:[],i=n?n.inviteRealms:[],a=new Set(t.realms),l=new Set(t.realms.concat(t.inviteRealms));for(const e of s)a.has(e)||(o.add(e),l.has(e)||r.add(e));for(const e of i.concat(s))l.has(e)||r.add(e);if(r.size>0||o.size>0){const t=me(e);for(const e of t){let t=["realms","members","roles"].includes(e.name)?r:o;0!==t.size&&(e.schema.indexes.some(e=>"realmId"===e.keyPath||Array.isArray(e.keyPath)&&"realmId"===e.keyPath[0])?yield e.where("realmId").anyOf([...t]).delete():yield e.filter(e=>!!(null==e?void 0:e.realmId)&&t.has(e.realmId)).delete())}}if(o.size>0&&(null==n?void 0:n.yDownloadedRealms))for(const e of o)delete n.yDownloadedRealms[e]})}(e,x,o);const s=o||{syncedTables:[],latestRevisions:{},realms:[],inviteRealms:[],clientIdentity:S};p&&(s.syncedTables=u.map(e=>e.name).concat(y.map(e=>e.name))),s.latestRevisions=k,s.remoteDbId=x.dbId,s.initiallySynced=!0,s.realms=x.realms,s.inviteRealms=x.inviteRealms,s.serverRevision=x.serverRevision,s.yServerRevision=x.serverRevision,s.timestamp=new Date,delete s.error;const i=Lt(x.changes,r);if(yield Ot(i,e),x.yMessages){const{receivedUntils:t,resyncNeeded:n,yServerRevision:r}=yield Ut(x.yMessages,e);r&&(s.yServerRevision=r),yield function(e,t,n){return Z(this,void 0,void 0,function*(){var r,o,s,i,a;const l={};for(const[t,n]of Object.entries(e))null!==(r=l[t])&&void 0!==r||(l[t]={}),l[t].unsentFrom=n+1;for(const[e,n]of Object.entries(t))null!==(o=l[e])&&void 0!==o||(l[e]={}),l[e].receivedUntil=n;const c=Object.values(n.dx._dbSchema).filter(e=>e.yProps).map(e=>e.yProps.map(e=>e.updatesTable)).flat();for(const e of c){const t=l[e],r=null!==(s=null==t?void 0:t.unsentFrom)&&void 0!==s?s:1,o=null!==(a=null!==(i=null==t?void 0:t.receivedUntil)&&void 0!==i?i:(yield n.table(e).where("i").between(1,1/0).reverse().limit(1).primaryKeys())[0])&&void 0!==a?a:0;yield n.transaction("rw",e,()=>Z(this,void 0,void 0,function*(){const t=yield n.table(e).get(Ct);t?(t.unsentFrom=Math.max(r,t.unsentFrom||1),t.receivedUntil=Math.max(o,t.receivedUntil||0),yield n.table(e).put(t)):yield n.table(e).add({i:Ct,unsentFrom:r,receivedUntil:o})}))}})}(_,t,e),n&&(s.yDownloadedRealms={})}return e.$syncState.put(s,"syncState"),{done:0===r.length,newSyncState:s}}));if(!I)return yield _t(e),yield Dt(e,t,n,{isInitialSync:r,cancelToken:o});const O=Object.values(n).some(e=>{var t;return null===(t=e.yProps)||void 0===t?void 0:t.length}),C=!!x.yMessages;if(O&&C)try{yield Pt(e,l,E)}catch(e){}return e.syncCompleteEvent.next(),!1})}function Lt(e,t){const n={};Te(n,e);const r={};return Te(r,t),function(e,t){for(const[n,r]of Object.entries(t))for(const[t,o]of Object.entries(r))switch(o.type){case"ups":{const r=e[n]?.[t];if(r)switch(r.type){case"ups":case"upd":delete e[n][t]}}break;case"del":delete e[n]?.[t];break;case"upd":{const r=e[n]?.[t];if(r)switch(r.type){case"ups":for(const[e,t]of Object.entries(o.mod))xe(r.val,e,t);break;case"del":break;case"upd":for(const e of Object.keys(o.mod))delete r.mod[e]}break}}}(n,r),function(e,t){const n={};for(const[t,r]of Object.entries(e))for(const[e,o]of Object.entries(r)){const r=n[t]||(n[t]={});(r[o.type]||(r[o.type]=[])).push({key:e,...o})}const r=[];for(const[e,o]of Object.entries(n)){const n={table:e,muts:[]};for(const[e,r]of Object.entries(o))switch(e){case"ups":{const e={type:"upsert",keys:r.map(e=>e.key),values:r.map(e=>e.val),txid:t};n.muts.push(e);break}case"upd":{const e={type:"update",keys:r.map(e=>e.key),changeSpecs:r.map(e=>e.mod),txid:t};n.muts.push(e);break}case"del":{const e={type:"delete",keys:r.map(e=>e.key),txid:t};n.muts.push(e);break}}r.push(n)}return r}(n)}function Rt(t){const n=[],r=new i(!0),o=new i(null);let s=!1,l=new Array(10).fill(0);return o.subscribe(()=>Z(this,void 0,void 0,function*(){if(!s&&n.length>0){s=!0,l.shift(),l.push(Date.now()),r.next(!1);try{yield function(){return Z(this,void 0,void 0,function*(){for(var r,o,s,i,l,c;n.length>0;){const u=n.shift();try{yield a(t.cloud.syncState.pipe(x(({phase:e})=>"in-sync"===e||"error"===e)));const n=t.cloud.persistedSyncState.value;if(!u)continue;switch(u.type){case"token-expired":const a=t.cloud.currentUser.value,d=yield Be(t.cloud.options.databaseUrl,a);yield t.table("$logins").update(a.userId,{accessToken:d.accessToken,accessTokenExpiration:d.accessTokenExpiration,claims:d.claims,license:d.license,data:d.data});break;case"realm-added":(null===(r=null==n?void 0:n.realms)||void 0===r?void 0:r.includes(u.realm))||(null===(o=null==n?void 0:n.inviteRealms)||void 0===o?void 0:o.includes(u.realm))||(yield t.cloud.sync({purpose:"pull",wait:!0}));break;case"realm-accepted":(null===(s=null==n?void 0:n.realms)||void 0===s?void 0:s.includes(u.realm))||(yield t.cloud.sync({purpose:"pull",wait:!0}));break;case"realm-removed":((null===(i=null==n?void 0:n.realms)||void 0===i?void 0:i.includes(u.realm))||(null===(l=null==n?void 0:n.inviteRealms)||void 0===l?void 0:l.includes(u.realm)))&&(yield t.cloud.sync({purpose:"pull",wait:!0}));break;case"realms-changed":yield t.cloud.sync({purpose:"pull",wait:!0});break;case"changes":if("error"===(null===(c=t.cloud.syncState.value)||void 0===c?void 0:c.phase)){ue(t,"pull");break}yield t.transaction("rw",t.dx.tables,n=>Z(this,void 0,void 0,function*(){n.idbtrans.disableChangeTracking=!0,n.idbtrans.disableAccessControl=!0;const[r,o,s]=yield Promise.all([t.getSchema(),t.getPersistedSyncState(),t.getCurrentUser()]);if(!o||!r||!s)return;if(u.baseRev!==o.serverRevision)return void("string"!=typeof u.baseRev||"bigint"!=typeof o.serverRevision&&"object"!=typeof o.serverRevision||ue(t,"pull"));if((yield e.waitFor(he(o)))!==u.realmSetHash)return void ue(t,"pull");let i=[];if(s.isLoggedIn){const e=me(t).map(e=>t.table(ve(e.name)));i=yield we(e,t)}if(u.changes.length>0){const e=Lt(u.changes,i);yield Ot(e,t)}o.latestRevisions=It(i,o.latestRevisions),o.serverRevision=u.newRev,yield xt(t,r,o.latestRevisions,u.newRev),yield t.$syncState.put(o,"syncState")}))}}catch(e){}}})}()}finally{l[l.length-1]-l[0]<1e4&&(yield new Promise(e=>setTimeout(e,1e3))),s=!1,r.next(!0)}}})),{enqueue:function(e){n.push(e),o.next(null)},readyToServe:r}}const Nt=new WeakMap,Bt={members:"@id, [userId+realmId], [email+realmId], realmId",roles:"[realmId+name]",realms:"@realmId",$jobs:"",$syncState:"",$baseRevs:"[tableName+clientRev]",$logins:"claims.sub, lastLogin"};let Mt=0;function Wt(e){"vip"in e&&(e=e.vip);let t=Nt.get(e.cloud);if(!t){const n=new l;let r=new ae(`syncstatechanged-${e.name}`),o=new ae(`synccomplete-${e.name}`);n.id=++Mt;let s=!1;t={get name(){return e.name},close:()=>e.close(),transaction:e.transaction.bind(e),table:e.table.bind(e),get tables(){return e.tables},cloud:e.cloud,get $jobs(){return e.table("$jobs")},get $syncState(){return e.table("$syncState")},get $baseRevs(){return e.table("$baseRevs")},get $logins(){return e.table("$logins")},get realms(){return e.realms},get members(){return e.members},get roles(){return e.roles},get initiallySynced(){return s},localSyncEvent:n,get syncStateChangedEvent(){return r},get syncCompleteEvent(){return o},dx:e};const i={getCurrentUser:()=>t.$logins.toArray().then(e=>e.find(e=>e.isLoggedIn)||ne),getPersistedSyncState:()=>t.$syncState.get("syncState"),getSchema:()=>t.$syncState.get("schema").then(e=>{if(e)for(const n of t.tables)n.schema.primKey&&n.schema.primKey.keyPath&&e[n.name]&&(e[n.name].primaryKey=Ft(n.schema.primKey.keyPath));return e}),getOptions:()=>t.$syncState.get("options"),setInitiallySynced(e){s=e},reconfigure(){r=new ae(`syncstatechanged-${e.name}`),o=new ae(`synccomplete-${e.name}`)}};Object.assign(t,i),t.messageConsumer=Rt(t),t.messageProducer=new l,Nt.set(e.cloud,t)}return t}function Ft(e){return"string"==typeof e?e:e?"["+[].join.call(e,"+")+"]":""}const Kt=new WeakMap;class Ht{constructor(e,t){Kt.set(this,e),Object.assign(this,t)}static load(e,t){return e.table("$logins").get(t).then(n=>new Ht(e,n||{userId:t,claims:{sub:t},lastLogin:new Date(0)}))}save(){return Z(this,void 0,void 0,function*(){Kt.get(this).table("$logins").put(this)})}}function Vt(e,t){return a(c(e).pipe(u(t)))}function zt(e){return Z(this,void 0,void 0,function*(){const t=yield Jt(e);if(t){if(!(yield function(e,t,n){return Z(this,void 0,void 0,function*(){const r=[{type:"warning",messageCode:"LOGOUT_CONFIRMATION",message:"{numUnsyncedChanges} unsynced changes will get lost!\n                Logout anyway?",messageParams:{currentUserId:t,numUnsyncedChanges:n.toString()}}];return yield Ae(e,{type:"logout-confirmation",title:"Confirm Logout",alerts:r,fields:{},submitLabel:"Confirm logout",cancelLabel:"Cancel"}).then(()=>!0).catch(()=>!1)})}(e.cloud.userInteraction,e.cloud.currentUserId,t)))throw new Error("User cancelled logout due to unsynced changes");yield Jt(e,{deleteUnsyncedData:!0})}})}function Jt(e){return Z(this,arguments,void 0,function*(e,{deleteUnsyncedData:t=!1}={}){const[n,r]=yield e.dx.transaction("rw",e.dx.tables,n=>Z(this,void 0,void 0,function*(){const r=n.idbtrans;r.disableChangeTracking=!0,r.disableAccessControl=!0;const o=n.storeNames.filter(e=>e.endsWith("_mutations")),s=(yield Promise.all(o.map(e=>n.table(e).count()))).reduce((e,t)=>e+t,0);if(s>0&&!t)return[s,!1];e.$syncState.delete("syncState");for(const t of e.dx.tables)"$jobs"!==t.name&&"$syncState"!==t.name&&t.clear();return[s,!0]}));return r&&(yield Vt(e.cloud.currentUser,e=>e.userId===ne.userId),yield e.cloud.sync({purpose:"pull",wait:!0})),n})}function qt(e,...t){globalThis.console[e](...t)}function Gt(e,t){return Z(this,void 0,void 0,function*(){var n;const r=yield e.getCurrentUser(),o=r.userId;if(r.isLoggedIn&&(!t||!t.email&&!t.userId)){if("ok"===((null===(n=r.license)||void 0===n?void 0:n.status)||"ok")&&r.accessToken&&(!r.accessTokenExpiration||r.accessTokenExpiration.getTime()>Date.now()))return!1;if(r.refreshToken&&(!r.refreshTokenExpiration||r.refreshTokenExpiration.getTime()>Date.now()))return yield Re(e),!1}const s=new Ht(e,{claims:{},lastLogin:new Date(0)});return yield Ne(e.cloud.options.databaseUrl,s,e.cloud.options.fetchTokens||function(e){const{userInteraction:t}=e.cloud;return function(n){return Z(this,arguments,void 0,function*({public_key:n,hints:r}){var o;let s;const i=null===(o=e.cloud.options)||void 0===o?void 0:o.databaseUrl;if(!i)throw new Error("No database URL given.");if("demo"===(null==r?void 0:r.grant_type))s={demo_user:yield De(t,"Enter a demo user email",(null==r?void 0:r.email)||(null==r?void 0:r.userId)),grant_type:"demo",scopes:["ACCESS_DB"],public_key:n};else if((null==r?void 0:r.otpId)&&r.otp)s={grant_type:"otp",otp_id:r.otpId,otp:r.otp,scopes:["ACCESS_DB"],public_key:n};else{const e=yield De(t,"Enter email address",null==r?void 0:r.email);s=/@demo.local$/.test(e)?{demo_user:e,grant_type:"demo",scopes:["ACCESS_DB"],public_key:n}:{email:e,grant_type:"otp",scopes:["ACCESS_DB"]}}const a=yield fetch(`${i}/token`,{body:JSON.stringify(s),method:"post",headers:{"Content-Type":"application/json",mode:"cors"}});if(200!==a.status){const e=yield a.text();throw yield $e(t,"Token request failed",{type:"error",messageCode:"GENERIC_ERROR",message:e,messageParams:{}}).catch(()=>{}),new mt(a,e)}const l=yield a.json();if("tokens"===l.type||"error"===l.type)return l;if("otp"===s.grant_type&&"email"in s){if("otp-sent"!==l.type)throw new Error(`Unexpected response from ${i}/token`);const e=yield Le(t,s.email),r=Object.assign(Object.assign({},s),{otp:e||"",otp_id:l.otp_id,public_key:n});let o=yield fetch(`${i}/token`,{body:JSON.stringify(r),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"});for(;401===o.status;){const e=yield o.text();r.otp=yield Le(t,s.email,{type:"error",messageCode:"INVALID_OTP",message:e,messageParams:{}}),o=yield fetch(`${i}/token`,{body:JSON.stringify(r),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"})}if(200!==o.status){const e=yield o.text();throw new mt(o,e)}return yield o.json()}throw new Error(`Unexpected response from ${i}/token`)})}}(e),e.cloud.userInteraction,t),o!==ne.userId&&s.userId!==o&&(yield zt(e)),yield function(e,t){return Z(this,void 0,void 0,function*(){const n=e.table("$logins");yield e.transaction("rw",n,e=>Z(this,void 0,void 0,function*(){const e=yield n.toArray();yield Promise.all(e.filter(e=>e.userId!==t.userId&&e.isLoggedIn).map(e=>(e.isLoggedIn=!1,n.put(e)))),t.isLoggedIn=!0,t.lastLogin=new Date;try{yield t.save()}catch(e){try{"DataCloneError"===e.name&&(qt("debug","Login context property names:",Object.keys(t)),qt("debug","Login context property names:",Object.keys(t)),qt("debug","Login context:",t),qt("debug","Login context JSON:",JSON.stringify(t)))}catch(e){}throw e}})),yield Vt(e.cloud.currentUser,e=>e.userId===t.userId)})}(e,s),ue(e,"pull"),s.userId!==o})}const Yt="undefined"!=typeof InstallTrigger,Zt="undefined"!=typeof navigator&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\/|Edge\//.test(navigator.userAgent),Xt=Zt?[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]:NaN,Qt=Zt&&Xt<=605||Yt,en="undefined"!=typeof self&&"clients"in self&&!self.document;const{toString:tn}={};function nn(e){return tn.call(e).slice(8,-1)}function rn(e,t){var n;return"delete"===t.type?t.keys:(null===(n=t.keys)||void 0===n?void 0:n.slice())||t.values.map(e.extractKey)}function on(e,t){return(1&t?e[0].toUpperCase():e[0].toLowerCase())+(2&t?e[1].toUpperCase():e[1].toLowerCase())+(4&t?e[2].toUpperCase():e[2].toLowerCase())}const sn=/b|c|d|f|g|h|j|k|l|m|n|p|q|r|s|t|v|x|y|z/i;function an(e){return e>="A"&&e<="Z"}let ln=0;function cn(e,t){const n=new Uint8Array(18),r=new Uint8Array(n.buffer,0,6),o=Date.now();ln>=o?++ln:ln=o,r[0]=ln/1099511627776,r[1]=ln/4294967296,r[2]=ln/16777216,r[3]=ln/65536,r[4]=ln/256,r[5]=ln;const s=new Uint8Array(n.buffer,6);crypto.getRandomValues(s);return e+Ze(new Uint8Array(n.buffer))+(t||"")}function un(t){return{stack:"dbcore",name:"idGenerationMiddleware",level:1,create:n=>Object.assign(Object.assign({},n),{table:r=>{const o=n.table(r);return Object.assign(Object.assign({},o),{mutate:n=>{var s,i;const a=n.trans;if("versionchange"===a.mode&&(a.disableChangeTracking=!0,a.disableAccessControl=!0),a.disableChangeTracking)return o.mutate(n);if("add"===n.type||"put"===n.type){const a=null===(s=t.cloud.schema)||void 0===s?void 0:s[r];if(null==a?void 0:a.generatedGlobalId){if((null===(i=t.cloud.options)||void 0===i?void 0:i.databaseUrl)&&!t.initiallySynced){const e=rn(o.schema.primaryKey,n);return o.getMany({keys:e,trans:n.trans,cache:"immutable"}).then(t=>{if(t.length<e.length)throw new Error("Unable to create new objects without an initial sync having been performed.");return o.mutate(n)})}return function(n,s){let i=null;const a=rn(o.schema.primaryKey,n);return a.forEach((l,c)=>{if(void 0===l){const r=n.values[c].realmId||t.cloud.currentUserId,l=r.substr(r.length-3);a[c]=cn(s,l),o.schema.primaryKey.outbound||(i||(i=n.values.slice()),i[c]=e.deepClone(i[c]),e.setByKeyPath(i[c],o.schema.primaryKey.keyPath,a[c]))}else if("string"!=typeof l||!l.startsWith(s)&&!l.startsWith("#"+s))throw new e.ConstraintError(`The ID "${l}" is not valid for table "${r}". Primary '@' keys requires the key to be prefixed with "${s}" (or "#${s}).\nIf you want to generate IDs programmatically, remove '@' from the schema to get rid of this constraint. Dexie Cloud supports custom IDs as long as they are random and globally unique.`)}),o.mutate(Object.assign(Object.assign({},n),{keys:a,values:i||n.values}))}(n,a.idPrefix)}if(null==a?void 0:a.markedForSync){rn(o.schema.primaryKey,n).forEach((t,n)=>{if(!Oe(t)){const n=Array.isArray(t)?t.map(nn).join(","):nn(t);throw new e.ConstraintError(`Invalid primary key type ${n} for table ${r}. Tables marked for sync has primary keys of type string or Array of string (and optional numbers)`)}})}}return o.mutate(n)}})}})}}let dn=0;function fn(e,t){return function(n){const{readers:r,writers:o}=n.trans[t]||(n.trans[t]={writers:[],readers:[]}),s=o.length,i=(s>0?o[s-1].then(()=>e(n),()=>e(n)):e(n)).finally(()=>{r.splice(r.indexOf(i))});return r.push(i),i}}function pn(e,t){return function(n){const{readers:r,writers:o}=n.trans[t]||(n.trans[t]={writers:[],readers:[]});let s=(o.length>0?o[o.length-1].then(()=>e(n),()=>e(n)):r.length>0?(i=r,new Promise(e=>{0===i.length&&e([]);let t=i.length;const n=new Array(t);i.forEach((r,o)=>Promise.resolve(r).then(e=>n[o]={status:"fulfilled",value:e},e=>n[o]={status:"rejected",reason:e}).then(()=>--t||e(n)))})).then(()=>e(n)):e(n)).finally(()=>{o.shift()});var i;return o.push(s),s}}const yn=new i(new Set);function hn(e){var t,n,r,o;return(null===(t=e.cloud.options)||void 0===t?void 0:t.disableEagerSync)||"ok"!==(null===(r=null===(n=e.cloud.currentUser.value)||void 0===n?void 0:n.license)||void 0===r?void 0:r.status)||!(null===(o=e.cloud.options)||void 0===o?void 0:o.databaseUrl)}function mn({currentUserObservable:e,db:t}){return{stack:"dbcore",name:"MutationTrackingMiddleware",level:1,create:n=>{const o=new Set(n.schema.tables.map(e=>e.name)),s=n.schema.tables.filter(e=>!/^\$/.test(e.name)),i=new Map;for(const e of s){const t=`$${e.name}_mutations`;o.has(t)&&i.set(e.name,n.table(t))}return Object.assign(Object.assign({},n),{transaction:(r,o)=>{let s;if("readwrite"===o){const e=r.filter(e=>{var n,r;return null===(r=null===(n=t.cloud.schema)||void 0===n?void 0:n[e])||void 0===r?void 0:r.markedForSync}).map(e=>ve(e));s=n.transaction([...r,...e],o)}else s=n.transaction(r,o);if("readwrite"===o){s.txid=ke(16),s.opCount=0,s.currentUser=e.value,yn.value.add(s),yn.next(yn.value);const n=()=>{s.removeEventListener("complete",r),s.removeEventListener("error",n),s.removeEventListener("abort",n),yn.value.delete(s),yn.next(yn.value)},r=()=>{s.mutationsAdded&&!hn(t)&&ue(t,"push"),n()};s.addEventListener("complete",r),s.addEventListener("error",n),s.addEventListener("abort",n)}return s},table:e=>{const o=n.table(e);if(/^\$/.test(e))return e.endsWith("_mutations")?Object.assign(Object.assign({},o),{mutate:e=>("add"!==e.type&&"put"!==e.type||(e.trans.mutationsAdded=!0),o.mutate(e))}):"$logins"===e?Object.assign(Object.assign({},o),{mutate:e=>o.mutate(e).then(t=>(e.trans.mutationsAdded=!0,t)).catch(e=>Promise.reject(e))}):o;const{schema:s}=o,a=i.get(e);return a?function(e){const t="$lock"+ ++dn;return Object.assign(Object.assign({},e),{count:fn(e.count,t),get:fn(e.get,t),getMany:fn(e.getMany,t),openCursor:fn(e.openCursor,t),query:fn(e.query,t),mutate:pn(e.mutate,t)})}(Object.assign(Object.assign({},o),{mutate:n=>{var r,i,a;const c=n.trans;return c.txid?c.disableChangeTracking?o.mutate(n):(null===(i=null===(r=t.cloud.schema)||void 0===r?void 0:r[e])||void 0===i?void 0:i.markedForSync)&&(null===(a=c.currentUser)||void 0===a?void 0:a.isLoggedIn)?"deleteRange"===n.type?o.query({query:{range:n.range,index:s.primaryKey},trans:n.trans,values:!1}).then(e=>l({type:"delete",keys:e.result,trans:n.trans,criteria:{index:null,range:n.range}})):l(n):o.mutate(n):o.mutate(n)}})):o;function l(n){var i,l;const c=n.trans,u=null===(l=null===(i=t.cloud.options)||void 0===i?void 0:i.unsyncedProperties)||void 0===l?void 0:l[e],{txid:d,currentUser:{userId:f}}=c,{type:p}=n,y=++c.opCount;function h(e){if(!u)return e;let t=e;for(const n of Object.keys(e))u.some(e=>n===e||n.startsWith(e+"."))&&(t===e&&(t=Object.assign({},e)),delete t[n]);return t}return o.mutate(n).then(e=>{var t;const{numFailures:o,failures:i}=e;let l="delete"===p?n.keys:e.results,m="values"in n?n.values:[],v="changeSpec"in n?n.changeSpec:void 0,b="updates"in n?n.updates:void 0,g=!(!b||!("upsert"in n))&&n.upsert;if(o&&(l=l.filter((e,t)=>!i[t]),m=m.filter((e,t)=>!i[t])),u){if(m=m.map(e=>{const t=Object.assign({},e);for(const e of u)delete t[e];return t}),v&&(v=h(v),0===Object.keys(v).length))return e;if(b){let e=b.changeSpecs.map(h),t={keys:[],changeSpecs:[]};const n=new r;let o=!1;if(!g){for(let r=0,s=e.length;r<s;++r)Object.keys(e[r]).length>0?(t.keys.push(b.keys[r]),t.changeSpecs.push(e[r]),n.addKey(b.keys[r])):o=!0;if(b=t,o){let e=[],t=[];for(let r=0,o=l.length;r<o;++r)n.hasKey(l[r])&&(e.push(l[r]),t.push(m[r]));l=e,m=t}}}}const _=Date.now();let w="criteria"in n&&n.criteria?Object.assign(Object.assign({},n.criteria),{index:n.criteria.index===s.primaryKey.keyPath?null:n.criteria.index}):void 0;if(u&&(null==w?void 0:w.index)){const e=null===(t=s.indexes.find(e=>e.name===w.index))||void 0===t?void 0:t.keyPath;(e?"string"==typeof e?[e]:e:[]).some(e=>null==u?void 0:u.includes(e))&&(w=void 0)}const k="delete"===n.type?{type:"delete",ts:_,opNo:y,keys:l,criteria:w,txid:d,userId:f}:"add"===n.type?{type:"insert",ts:_,opNo:y,keys:l,txid:d,userId:f,values:m}:g&&b?{type:"upsert",ts:_,opNo:y,keys:l,values:m,changeSpecs:b.changeSpecs.filter((e,t)=>!i[t]),txid:d,userId:f}:w&&v?{type:"modify",ts:_,opNo:y,keys:l,criteria:w,changeSpec:v,txid:d,userId:f}:v?{type:"update",ts:_,opNo:y,keys:l,changeSpecs:l.map(()=>v),txid:d,userId:f}:b?{type:"update",ts:_,opNo:y,keys:b.keys,changeSpecs:b.changeSpecs,txid:d,userId:f}:{type:"upsert",ts:_,opNo:y,keys:l,values:m,txid:d,userId:f};return"isAdditionalChunk"in n&&n.isAdditionalChunk&&(k.isAdditionalChunk=!0),l.length>0||w?a.mutate({type:"add",trans:c,values:[k]}).then(()=>(c.mutationsAdded=!0,e)):e})}}})}}}function vn(e,t){return function(n,r){var o;const s=Object.assign(Object.assign({},Bt),n);Object.keys(Bt).forEach(e=>{const t=s[e];if(null==t)throw new Error(`Cannot delete table ${e} as it is needed for access control of Dexie Cloud`);if(!n[e])return;const r=t.split(",").map(e=>e.trim()),o=Bt[e].split(",").map(e=>e.trim()),i=new Set(r.map(e=>e.replace(/([&*]|\+\+)/g,"")));if(r[0]!==o[0])throw new Error(`Cannot override primary key of table ${e}. Please declare it as {${e}: ${JSON.stringify(Bt[e])}`);for(let t=1;t<o.length;++t){const n=o[t];i.has(n.replace(/([&*]|\+\+)/g,""))||(s[e]+=`,${n}`)}});const i=t.cloud.schema||(t.cloud.schema={}),a=new Set;Object.keys(s).forEach(e=>{var t;const n=null===(t=s[e])||void 0===t?void 0:t.trim(),r=i[e]||(i[e]={});null!=n?(/^\@/.test(n)&&(s[e]=s[e].substr(1),r.generatedGlobalId=!0,r.idPrefix=function(e,t){let n=e[0].toLocaleLowerCase();for(let t=1,r=e.length;t<r&&n.length<3;++t)(sn.test(e[t])||an(e[t]))&&(n+=e[t].toLowerCase());for(;t.has(n);){if(/\d/g.test(n)){if(n=n.substr(0,n.length-1)+(n[n.length-1]+1),!(n.length>3))continue;n=n.substr(0,3)}else if(n.length<3){n+="2";continue}let e=1,r=n;for(;t.has(r)&&e<8;)r=on(n,e),++e;if(e<8)n=r;else{let e=n.charCodeAt(2)+1&127;n=n.substr(0,2)+String.fromCharCode(e)}}return n}(e,a),a.add(r.idPrefix)),/^\$/.test(e)||(s[`$${e}_mutations`]="++rev",r.markedForSync=!0),r.deleted&&(r.deleted=!1)):(r.deleted=!0,r.markedForSync=!1,s[`$${e}_mutations`]=null)});const l=e.call(this,s,r);for(const[e,t]of Object.entries(r))if(null===(o=t.yProps)||void 0===o?void 0:o.length){const n=i[e];n&&(n.yProps=t.yProps.map(e=>e.prop))}return l}}function bn(e,t,n){return"undefined"!=typeof navigator&&navigator.locks?navigator.locks.request(e.name+"|"+t,n):n()}const gn=new i(!0),_n=new i(!0);gn.pipe(I(e=>e?d(!0):d(!1).pipe(E(2e4))),O()).subscribe(_n);const wn="undefined"!=typeof document?f(document,"visibilitychange"):d({}),kn=wn.pipe(x(()=>"hidden"===document.visibilityState)),Sn=wn.pipe(x(()=>"visible"===document.visibilityState)),xn="undefined"!=typeof window?p(Sn,f(window,"mousedown"),f(window,"mousemove"),f(window,"keydown"),f(window,"wheel"),f(window,"touchmove")):d({});"undefined"!=typeof document&&p(d(!0),kn,xn).pipe(C(()=>"visible"===document.visibilityState),j(e=>{gn.value!==e&&gn.next(e)}),I(e=>e?d(0).pipe(E(16e4),j(()=>gn.next(!1))):d(0))).subscribe(()=>{});class In extends Error{constructor(){super(...arguments),this.name="TokenExpiredError"}}const En=new WeakMap,On=new WeakMap;function Cn(e){let t=On.get(e);return t||(t=new l,On.set(e,t)),t}class jn extends s{constructor(e,t,n,r,o,s,i,a){super(l=>new Un(e,t,n,r,o,a,l,s,i))}}let Tn=0;class Un extends v{constructor(e,t,n,r,o,s,i,a,l){super(()=>this.teardown()),this.id=++Tn,this.subscriptions=new Set,this.reconnecting=!1,this.db=e,this.databaseUrl=e.cloud.options.databaseUrl,this.rev=t,this.yrev=n,this.realmSetHash=r,this.clientIdentity=o,this.user=s,this.subscriber=i,this.lastUserActivity=new Date,this.messageProducer=a,this.webSocketStatus=l,this.connect()}teardown(){this.disconnect()}disconnect(){if(this.webSocketStatus.next("disconnected"),this.pinger&&(clearInterval(this.pinger),this.pinger=null),this.ws)try{this.ws.close()}catch(e){}this.ws=null;for(const e of this.subscriptions)e.unsubscribe();this.subscriptions.clear()}reconnect(){if(!this.reconnecting){this.reconnecting=!0;try{this.disconnect()}catch(e){}this.connect().catch(()=>{}).then(()=>this.reconnecting=!1)}}connect(){return Z(this,void 0,void 0,function*(){if(this.lastServerActivity=new Date,this.pauseUntil&&this.pauseUntil>new Date)return;if(this.ws)throw new Error("Called connect() when a connection is already open");if(!this.databaseUrl)throw new Error("Cannot connect without a database URL");if(this.closed)return;const e=this.user.accessTokenExpiration;if(e&&e<new Date)return void this.subscriber.error(new In);this.webSocketStatus.next("connecting"),this.pinger=setInterval(()=>Z(this,void 0,void 0,function*(){if(this.closed)this.teardown();else if(this.ws)try{this.ws.send(JSON.stringify({type:"ping"})),setTimeout(()=>{this.pinger&&(this.closed?this.teardown():this.lastServerActivity<new Date(Date.now()-2e4)&&this.reconnect())},2e4)}catch(e){this.reconnect()}else this.reconnect()}),3e4);const t=new URL(this.databaseUrl);t.protocol="http:"===t.protocol?"ws":"wss";const n=new URLSearchParams;if(this.subscriber.closed)return;n.set("v","2"),this.rev&&n.set("rev",this.rev),this.yrev&&n.set("yrev",this.yrev),n.set("realmsHash",this.realmSetHash),n.set("clientId",this.clientIdentity),n.set("dxcv",this.db.cloud.version),this.user.accessToken&&n.set("token",this.user.accessToken);const r=this.ws=new WebSocket(`${t}/changes?${n}`);r.binaryType="arraybuffer",r.onclose=e=>{this.pinger&&this.reconnect()},r.onmessage=e=>{if(this.pinger){this.lastServerActivity=new Date;try{const t="string"==typeof e.data?yt.parse(e.data):function(e){const t=new W(e),n=F(t);if("outdated-server-rev"===n)return{type:n};if("y-complete-sync-done"===n)return{type:n,yServerRev:F(t)};const r=F(t),o=F(t);switch(n){case"u-ack":case"u-reject":return{type:n,table:r,prop:o,i:Number(V(t))};default:{const e=K(t);switch(n){case"in-sync":case"doc-close":return{type:n,table:r,prop:o,k:e};case"aware":return{type:n,table:r,prop:o,k:e,u:H(t)};case"doc-open":return{type:n,table:r,prop:o,k:e,serverRev:K(t),sv:K(t)};case"sv":return{type:n,table:r,prop:o,k:e,sv:H(t)};case"u-c":return{type:n,table:r,prop:o,k:e,u:H(t),i:Number(V(t))};case"u-s":return{type:n,table:r,prop:o,k:e,u:H(t),r:t.pos<t.arr.length&&F(t)||void 0};default:throw new TypeError(`Unknown message type: ${n}`)}}}}(new Uint8Array(e.data));if("error"===t.type)throw new Error(`Error message from dexie-cloud: ${t.error}`);if("aware"===t.type){const e=G.getDocCache(this.db.dx).find(t.table,t.k,t.prop);if(e){const n=(e=>En.get(e))(e);n&&Y.applyAwarenessUpdate(n,t.u,"server")}}else if("pong"===t.type);else if("doc-open"===t.type){const e=G.getDocCache(this.db.dx).find(t.table,t.k,t.prop);e&&Cn(e).next()}else"u-ack"===t.type||"u-reject"===t.type||"u-s"===t.type||"in-sync"===t.type||"outdated-server-rev"===t.type||"y-complete-sync-done"===t.type?Ut([t],this.db).then(e=>Z(this,[e],void 0,function*({resyncNeeded:e,yServerRevision:n,receivedUntils:r}){if(n&&(yield this.db.$syncState.update("syncState",{yServerRevision:n})),"u-s"===t.type&&r){const e=Tt(this.db,t.table,t.prop);if(e){const t=r[e.name];t&&(yield e.update(Ct,{receivedUntil:t}))}}e&&(yield this.db.cloud.sync({purpose:"pull",wait:!0}))})):this.subscriber.next(t)}catch(e){this.subscriber.error(e)}}};try{let e=!1;yield new Promise((t,n)=>{r.onopen=n=>{e=!0,t(null)},r.onerror=t=>{if(e)this.reconnect();else{const e=t.error||new Error("WebSocket Error");this.subscriber.error(e),this.webSocketStatus.next("error"),n(e)}}}),this.subscriptions.add(this.messageProducer.subscribe(e=>{var t,n;this.closed||("ready"===e.type&&"connected"!==this.webSocketStatus.value&&this.webSocketStatus.next("connected"),"ready"===e.type?(this.rev=e.rev,null===(t=this.ws)||void 0===t||t.send(yt.stringify(e))):null===(n=this.ws)||void 0===n||n.send(function(e){const t=new D;switch(L(t,e.type),"table"in e&&L(t,e.table),"prop"in e&&L(t,e.prop),e.type){case"u-ack":case"u-reject":B(t,BigInt(e.i));break;case"outdated-server-rev":break;case"y-complete-sync-done":L(t,e.yServerRev);break;default:switch(R(t,e.k),e.type){case"aware":N(t,e.u);break;case"doc-open":R(t,e.serverRev),R(t,e.sv);break;case"doc-close":break;case"sv":N(t,e.sv);break;case"u-c":N(t,e.u),B(t,BigInt(e.i));break;case"u-s":N(t,e.u),L(t,e.r||"")}}return M(t)}(e)))})),this.user.isLoggedIn&&!hn(this.db)&&this.subscriptions.add(function(e){const t=_e(e.tables.filter(t=>{var n,r;return(null===(r=null===(n=e.cloud.schema)||void 0===n?void 0:n[t.name])||void 0===r?void 0:r.markedForSync)&&t.schema.yProps}).map(e=>e.schema.yProps.map(t=>({table:e.name,ydocProp:t.prop,updatesTable:t.updatesTable}))));return p(...t.map(({table:t,ydocProp:n,updatesTable:r})=>{const s=e.table(r);return c(s.get(Ct)).pipe(y(e=>{let r=(null==e?void 0:e.unsentFrom)||1;return c(o(()=>Z(this,void 0,void 0,function*(){return(yield jt(s,r)).filter(e=>e.f&&1&e.f).map(e=>({type:"u-c",table:t,prop:n,k:e.k,u:e.u,i:e.i}))}))).pipe(h(e=>{e.length>0&&(r=e.at(-1).i+1)}))}))})).pipe(m(e=>e))}(this.db).subscribe(this.db.messageProducer))}catch(e){this.pauseUntil=new Date(Date.now()+6e4)}})}}class Pn extends Error{constructor(e){super("expired"===e?"License expired":"deactivated"===e?"User deactivated":"Invalid license"),this.name="InvalidLicenseError",e&&(this.license=e)}}function An(e){return Z(this,void 0,void 0,function*(){var e;yield(e=3e3,new Promise(t=>setTimeout(t,e))),yield a(xn)})}function $n(e){return Z(this,void 0,void 0,function*(){var t;return!(!(null===(t=e.cloud.options)||void 0===t?void 0:t.databaseUrl)||!e.cloud.schema)&&(yield $t(e,e.cloud.options,e.cloud.schema,{justCheckIfNeeded:!0}))})}const Dn=new WeakMap;function Ln(e,t,n,r){const o=Dn.get(e);if(o){if(o.pull||"push"===(null==r?void 0:r.purpose))return o.promise;{let s=!1;const i=e.cloud.syncState.subscribe(e=>{"pulling"===e.phase&&(s=!0)});return o.promise.then(()=>{i.unsubscribe()}).catch(e=>(i.unsubscribe(),Promise.reject(e))).then(()=>{if(!s)return Ln(e,t,n,r)})}}const s=function(){return Z(this,void 0,void 0,function*(){try{yield _t(e),yield bn(e,At,()=>$t(e,t,n,r)),Dn.delete(e)}catch(t){throw Dn.delete(e),t}})}();return Dn.set(e,{promise:s,pull:"push"!==(null==r?void 0:r.purpose)}),s}function Rn(e,t,n){let r=null,o={cancelled:!1},s=0,i=0;function a(r=1){setTimeout(()=>{const d=l?"pull":"push";i=Date.now(),Ln(e,t,n,{cancelToken:o,retryImmediatelyOnFetchError:!0,purpose:d}).then(()=>{if(o.cancelled)f();else if(l||c)return l=!1,c=!1,a();u=!1,s=0,i=0}).catch(e=>{if(o.cancelled)f(),u=!1,s=0,i=0;else if(r<5){const e=1e3*[0,20,40,300,900][r];s=Date.now()+e,i=0,setTimeout(()=>a(r+1),e)}else u=!1,s=0,i=0})},0)}let l=!1,c=!1,u=!1;const d=e=>{o.cancelled||("pull"===e&&(l=!0),"push"===e&&(c=!0),u?s||i>0&&Date.now():(u=!0,a()))},f=()=>{o.cancelled=!0,r&&r.unsubscribe()};return{start:()=>{r=e.localSyncEvent.subscribe(({purpose:e})=>{d(e||"pull")})},stop:f}}function Nn(e,t){if(e&&t&&t.unsyncedTables)for(const n of t.unsyncedTables)e[n]&&(e[n].markedForSync=!1)}var Bn,Mn,Wn,Fn,Kn,Hn,Vn,zn,Jn,qn,Gn,Yn={},Zn=[],Xn=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,Qn=Array.isArray;function er(e,t){for(var n in t)e[n]=t[n];return e}function tr(e){e&&e.parentNode&&e.parentNode.removeChild(e)}function nr(e,t,n){var r,o,s,i={};for(s in t)"key"==s?r=t[s]:"ref"==s?o=t[s]:i[s]=t[s];if(arguments.length>2&&(i.children=arguments.length>3?Bn.call(arguments,2):n),"function"==typeof e&&null!=e.defaultProps)for(s in e.defaultProps)void 0===i[s]&&(i[s]=e.defaultProps[s]);return rr(e,i,r,o,null)}function rr(e,t,n,r,o){var s={type:e,props:t,key:n,ref:r,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:null==o?++Wn:o,__i:-1,__u:0};return null==o&&null!=Mn.vnode&&Mn.vnode(s),s}function or(e){return e.children}function sr(e,t){this.props=e,this.context=t}function ir(e,t){if(null==t)return e.__?ir(e.__,e.__i+1):null;for(var n;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e)return n.__e;return"function"==typeof e.type?ir(e):null}function ar(e){var t,n;if(null!=(e=e.__)&&null!=e.__c){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e){e.__e=e.__c.base=n.__e;break}return ar(e)}}function lr(e){(!e.__d&&(e.__d=!0)&&Fn.push(e)&&!cr.__r++||Kn!=Mn.debounceRendering)&&((Kn=Mn.debounceRendering)||Hn)(cr)}function cr(){for(var e,t,n,r,o,s,i,a=1;Fn.length;)Fn.length>a&&Fn.sort(Vn),e=Fn.shift(),a=Fn.length,e.__d&&(n=void 0,r=void 0,o=(r=(t=e).__v).__e,s=[],i=[],t.__P&&((n=er({},r)).__v=r.__v+1,Mn.vnode&&Mn.vnode(n),mr(t.__P,n,r,t.__n,t.__P.namespaceURI,32&r.__u?[o]:null,s,null==o?ir(r):o,!!(32&r.__u),i),n.__v=r.__v,n.__.__k[n.__i]=n,br(s,n,i),r.__e=r.__=null,n.__e!=o&&ar(n)));cr.__r=0}function ur(e,t,n,r,o,s,i,a,l,c,u){var d,f,p,y,h,m,v,b=r&&r.__k||Zn,g=t.length;for(l=function(e,t,n,r,o){var s,i,a,l,c,u=n.length,d=u,f=0;for(e.__k=new Array(o),s=0;s<o;s++)null!=(i=t[s])&&"boolean"!=typeof i&&"function"!=typeof i?("string"==typeof i||"number"==typeof i||"bigint"==typeof i||i.constructor==String?i=e.__k[s]=rr(null,i,null,null,null):Qn(i)?i=e.__k[s]=rr(or,{children:i},null,null,null):null==i.constructor&&i.__b>0?i=e.__k[s]=rr(i.type,i.props,i.key,i.ref?i.ref:null,i.__v):e.__k[s]=i,l=s+f,i.__=e,i.__b=e.__b+1,-1!=(c=i.__i=fr(i,n,l,d))&&(d--,(a=n[c])&&(a.__u|=2)),null==a||null==a.__v?(-1==c&&(o>u?f--:o<u&&f++),"function"!=typeof i.type&&(i.__u|=4)):c!=l&&(c==l-1?f--:c==l+1?f++:(c>l?f--:f++,i.__u|=4))):e.__k[s]=null;if(d)for(s=0;s<u;s++)null!=(a=n[s])&&!(2&a.__u)&&(a.__e==r&&(r=ir(a)),kr(a,a));return r}(n,t,b,l,g),d=0;d<g;d++)null!=(p=n.__k[d])&&(f=-1==p.__i?Yn:b[p.__i]||Yn,p.__i=d,m=mr(e,p,f,o,s,i,a,l,c,u),y=p.__e,p.ref&&f.ref!=p.ref&&(f.ref&&wr(f.ref,null,p),u.push(p.ref,p.__c||y,p)),null==h&&null!=y&&(h=y),(v=!!(4&p.__u))||f.__k===p.__k?l=dr(p,l,e,v):"function"==typeof p.type&&void 0!==m?l=m:y&&(l=y.nextSibling),p.__u&=-7);return n.__e=h,l}function dr(e,t,n,r){var o,s;if("function"==typeof e.type){for(o=e.__k,s=0;o&&s<o.length;s++)o[s]&&(o[s].__=e,t=dr(o[s],t,n,r));return t}e.__e!=t&&(r&&(t&&e.type&&!t.parentNode&&(t=ir(e)),n.insertBefore(e.__e,t||null)),t=e.__e);do{t=t&&t.nextSibling}while(null!=t&&8==t.nodeType);return t}function fr(e,t,n,r){var o,s,i,a=e.key,l=e.type,c=t[n],u=null!=c&&!(2&c.__u);if(null===c&&null==a||u&&a==c.key&&l==c.type)return n;if(r>(u?1:0))for(o=n-1,s=n+1;o>=0||s<t.length;)if(null!=(c=t[i=o>=0?o--:s++])&&!(2&c.__u)&&a==c.key&&l==c.type)return i;return-1}function pr(e,t,n){"-"==t[0]?e.setProperty(t,null==n?"":n):e[t]=null==n?"":"number"!=typeof n||Xn.test(t)?n:n+"px"}function yr(e,t,n,r,o){var s,i;e:if("style"==t)if("string"==typeof n)e.style.cssText=n;else{if("string"==typeof r&&(e.style.cssText=r=""),r)for(t in r)n&&t in n||pr(e.style,t,"");if(n)for(t in n)r&&n[t]==r[t]||pr(e.style,t,n[t])}else if("o"==t[0]&&"n"==t[1])s=t!=(t=t.replace(zn,"$1")),i=t.toLowerCase(),t=i in e||"onFocusOut"==t||"onFocusIn"==t?i.slice(2):t.slice(2),e.l||(e.l={}),e.l[t+s]=n,n?r?n.u=r.u:(n.u=Jn,e.addEventListener(t,s?Gn:qn,s)):e.removeEventListener(t,s?Gn:qn,s);else{if("http://www.w3.org/2000/svg"==o)t=t.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if("width"!=t&&"height"!=t&&"href"!=t&&"list"!=t&&"form"!=t&&"tabIndex"!=t&&"download"!=t&&"rowSpan"!=t&&"colSpan"!=t&&"role"!=t&&"popover"!=t&&t in e)try{e[t]=null==n?"":n;break e}catch(e){}"function"==typeof n||(null==n||!1===n&&"-"!=t[4]?e.removeAttribute(t):e.setAttribute(t,"popover"==t&&1==n?"":n))}}function hr(e){return function(t){if(this.l){var n=this.l[t.type+e];if(null==t.t)t.t=Jn++;else if(t.t<n.u)return;return n(Mn.event?Mn.event(t):t)}}}function mr(e,t,n,r,o,s,i,a,l,c){var u,d,f,p,y,h,m,v,b,g,_,w,k,S,x,I,E,O=t.type;if(null!=t.constructor)return null;128&n.__u&&(l=!!(32&n.__u),s=[a=t.__e=n.__e]),(u=Mn.__b)&&u(t);e:if("function"==typeof O)try{if(v=t.props,b="prototype"in O&&O.prototype.render,g=(u=O.contextType)&&r[u.__c],_=u?g?g.props.value:u.__:r,n.__c?m=(d=t.__c=n.__c).__=d.__E:(b?t.__c=d=new O(v,_):(t.__c=d=new sr(v,_),d.constructor=O,d.render=Sr),g&&g.sub(d),d.state||(d.state={}),d.__n=r,f=d.__d=!0,d.__h=[],d._sb=[]),b&&null==d.__s&&(d.__s=d.state),b&&null!=O.getDerivedStateFromProps&&(d.__s==d.state&&(d.__s=er({},d.__s)),er(d.__s,O.getDerivedStateFromProps(v,d.__s))),p=d.props,y=d.state,d.__v=t,f)b&&null==O.getDerivedStateFromProps&&null!=d.componentWillMount&&d.componentWillMount(),b&&null!=d.componentDidMount&&d.__h.push(d.componentDidMount);else{if(b&&null==O.getDerivedStateFromProps&&v!==p&&null!=d.componentWillReceiveProps&&d.componentWillReceiveProps(v,_),t.__v==n.__v||!d.__e&&null!=d.shouldComponentUpdate&&!1===d.shouldComponentUpdate(v,d.__s,_)){for(t.__v!=n.__v&&(d.props=v,d.state=d.__s,d.__d=!1),t.__e=n.__e,t.__k=n.__k,t.__k.some(function(e){e&&(e.__=t)}),w=0;w<d._sb.length;w++)d.__h.push(d._sb[w]);d._sb=[],d.__h.length&&i.push(d);break e}null!=d.componentWillUpdate&&d.componentWillUpdate(v,d.__s,_),b&&null!=d.componentDidUpdate&&d.__h.push(function(){d.componentDidUpdate(p,y,h)})}if(d.context=_,d.props=v,d.__P=e,d.__e=!1,k=Mn.__r,S=0,b){for(d.state=d.__s,d.__d=!1,k&&k(t),u=d.render(d.props,d.state,d.context),x=0;x<d._sb.length;x++)d.__h.push(d._sb[x]);d._sb=[]}else do{d.__d=!1,k&&k(t),u=d.render(d.props,d.state,d.context),d.state=d.__s}while(d.__d&&++S<25);d.state=d.__s,null!=d.getChildContext&&(r=er(er({},r),d.getChildContext())),b&&!f&&null!=d.getSnapshotBeforeUpdate&&(h=d.getSnapshotBeforeUpdate(p,y)),I=u,null!=u&&u.type===or&&null==u.key&&(I=gr(u.props.children)),a=ur(e,Qn(I)?I:[I],t,n,r,o,s,i,a,l,c),d.base=t.__e,t.__u&=-161,d.__h.length&&i.push(d),m&&(d.__E=d.__=null)}catch(e){if(t.__v=null,l||null!=s)if(e.then){for(t.__u|=l?160:128;a&&8==a.nodeType&&a.nextSibling;)a=a.nextSibling;s[s.indexOf(a)]=null,t.__e=a}else{for(E=s.length;E--;)tr(s[E]);vr(t)}else t.__e=n.__e,t.__k=n.__k,e.then||vr(t);Mn.__e(e,t,n)}else null==s&&t.__v==n.__v?(t.__k=n.__k,t.__e=n.__e):a=t.__e=_r(n.__e,t,n,r,o,s,i,l,c);return(u=Mn.diffed)&&u(t),128&t.__u?void 0:a}function vr(e){e&&e.__c&&(e.__c.__e=!0),e&&e.__k&&e.__k.forEach(vr)}function br(e,t,n){for(var r=0;r<n.length;r++)wr(n[r],n[++r],n[++r]);Mn.__c&&Mn.__c(t,e),e.some(function(t){try{e=t.__h,t.__h=[],e.some(function(e){e.call(t)})}catch(e){Mn.__e(e,t.__v)}})}function gr(e){return"object"!=typeof e||null==e||e.__b&&e.__b>0?e:Qn(e)?e.map(gr):er({},e)}function _r(e,t,n,r,o,s,i,a,l){var c,u,d,f,p,y,h,m=n.props||Yn,v=t.props,b=t.type;if("svg"==b?o="http://www.w3.org/2000/svg":"math"==b?o="http://www.w3.org/1998/Math/MathML":o||(o="http://www.w3.org/1999/xhtml"),null!=s)for(c=0;c<s.length;c++)if((p=s[c])&&"setAttribute"in p==!!b&&(b?p.localName==b:3==p.nodeType)){e=p,s[c]=null;break}if(null==e){if(null==b)return document.createTextNode(v);e=document.createElementNS(o,b,v.is&&v),a&&(Mn.__m&&Mn.__m(t,s),a=!1),s=null}if(null==b)m===v||a&&e.data==v||(e.data=v);else{if(s=s&&Bn.call(e.childNodes),!a&&null!=s)for(m={},c=0;c<e.attributes.length;c++)m[(p=e.attributes[c]).name]=p.value;for(c in m)if(p=m[c],"children"==c);else if("dangerouslySetInnerHTML"==c)d=p;else if(!(c in v)){if("value"==c&&"defaultValue"in v||"checked"==c&&"defaultChecked"in v)continue;yr(e,c,null,p,o)}for(c in v)p=v[c],"children"==c?f=p:"dangerouslySetInnerHTML"==c?u=p:"value"==c?y=p:"checked"==c?h=p:a&&"function"!=typeof p||m[c]===p||yr(e,c,p,m[c],o);if(u)a||d&&(u.__html==d.__html||u.__html==e.innerHTML)||(e.innerHTML=u.__html),t.__k=[];else if(d&&(e.innerHTML=""),ur("template"==t.type?e.content:e,Qn(f)?f:[f],t,n,r,"foreignObject"==b?"http://www.w3.org/1999/xhtml":o,s,i,s?s[0]:n.__k&&ir(n,0),a,l),null!=s)for(c=s.length;c--;)tr(s[c]);a||(c="value","progress"==b&&null==y?e.removeAttribute("value"):null!=y&&(y!==e[c]||"progress"==b&&!y||"option"==b&&y!=m[c])&&yr(e,c,y,m[c],o),c="checked",null!=h&&h!=e[c]&&yr(e,c,h,m[c],o))}return e}function wr(e,t,n){try{if("function"==typeof e){var r="function"==typeof e.__u;r&&e.__u(),r&&null==t||(e.__u=e(t))}else e.current=t}catch(e){Mn.__e(e,n)}}function kr(e,t,n){var r,o;if(Mn.unmount&&Mn.unmount(e),(r=e.ref)&&(r.current&&r.current!=e.__e||wr(r,null,t)),null!=(r=e.__c)){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(e){Mn.__e(e,t)}r.base=r.__P=null}if(r=e.__k)for(o=0;o<r.length;o++)r[o]&&kr(r[o],t,n||"function"!=typeof e.type);n||tr(e.__e),e.__c=e.__=e.__e=void 0}function Sr(e,t,n){return this.constructor(e,n)}function xr(e,t,n){var r,o,s;t==document&&(t=document.documentElement),Mn.__&&Mn.__(e,t),r=!1?null:t.__k,o=[],s=[],mr(t,e=t.__k=nr(or,null,[e]),r||Yn,Yn,t.namespaceURI,r?null:t.firstChild?Bn.call(t.childNodes):null,o,r?r.__e:t.firstChild,false,s),br(o,e,s)}Bn=Zn.slice,Mn={__e:function(e,t,n,r){for(var o,s,i;t=t.__;)if((o=t.__c)&&!o.__)try{if((s=o.constructor)&&null!=s.getDerivedStateFromError&&(o.setState(s.getDerivedStateFromError(e)),i=o.__d),null!=o.componentDidCatch&&(o.componentDidCatch(e,r||{}),i=o.__d),i)return o.__E=o}catch(t){e=t}throw e}},Wn=0,sr.prototype.setState=function(e,t){var n;n=null!=this.__s&&this.__s!=this.state?this.__s:this.__s=er({},this.state),"function"==typeof e&&(e=e(er({},n),this.props)),e&&er(n,e),null!=e&&this.__v&&(t&&this._sb.push(t),lr(this))},sr.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),lr(this))},sr.prototype.render=or,Fn=[],Hn="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,Vn=function(e,t){return e.__v.__b-t.__v.__b},cr.__r=0,zn=/(PointerCapture)$|Capture$/i,Jn=0,qn=hr(!1),Gn=hr(!0);const Ir={Alert:{error:{color:"red",fontWeight:"bold"},warning:{color:"#f80",fontWeight:"bold"},info:{color:"black"}},Darken:{position:"fixed",top:0,left:0,opacity:.5,backgroundColor:"#000",width:"100vw",height:"100vh",zIndex:150,webkitBackdropFilter:"blur(2px)",backdropFilter:"blur(2px)"},DialogOuter:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:150,alignItems:"center",display:"flex",justifyContent:"center",padding:"16px",boxSizing:"border-box"},DialogInner:{position:"relative",color:"#222",backgroundColor:"#fff",padding:"24px",marginBottom:"2em",maxWidth:"400px",width:"100%",maxHeight:"90%",overflowY:"auto",border:"3px solid #3d3d5d",borderRadius:"8px",boxShadow:"0 0 80px 10px #666",fontFamily:"sans-serif",boxSizing:"border-box"},Input:{height:"35px",width:"100%",maxWidth:"100%",borderColor:"#ccf4",outline:"none",fontSize:"16px",padding:"8px",boxSizing:"border-box",backgroundColor:"#f9f9f9",borderRadius:"4px",border:"1px solid #ccc",marginTop:"6px",fontFamily:"inherit"},Button:{padding:"10px 20px",margin:"0 4px",border:"1px solid #d1d5db",borderRadius:"6px",backgroundColor:"#ffffff",cursor:"pointer",fontSize:"14px",fontWeight:"500",color:"#374151",transition:"all 0.2s ease"},PrimaryButton:{padding:"10px 20px",margin:"0 4px",border:"1px solid #3b82f6",borderRadius:"6px",backgroundColor:"#3b82f6",color:"white",cursor:"pointer",fontSize:"14px",fontWeight:"500",transition:"all 0.2s ease"},ButtonsDiv:{display:"flex",justifyContent:"flex-end",gap:"12px",marginTop:"24px",paddingTop:"20px"},Label:{display:"block",marginBottom:"12px",fontSize:"14px",fontWeight:"500",color:"#333"},WindowHeader:{margin:"0 0 20px 0",fontSize:"18px",fontWeight:"600",color:"#333",borderBottom:"1px solid #eee",paddingBottom:"10px"}};function Er({children:e,className:t}){return nr("div",{className:`dexie-dialog ${t||""}`},nr("div",{style:Ir.Darken}),nr("div",{style:Ir.DialogOuter},nr("div",{style:Ir.DialogInner},e)))}var Or,Cr,jr,Tr,Ur=0,Pr=[],Ar=Mn,$r=Ar.__b,Dr=Ar.__r,Lr=Ar.diffed,Rr=Ar.__c,Nr=Ar.unmount,Br=Ar.__;function Mr(e,t){Ar.__h&&Ar.__h(Cr,e,Ur||t),Ur=0;var n=Cr.__H||(Cr.__H={__:[],__h:[]});return e>=n.__.length&&n.__.push({}),n.__[e]}function Wr(e){return Ur=1,function(e,t){var n=Mr(Or++,2);if(n.t=e,!n.__c&&(n.__=[Gr(void 0,t),function(e){var t=n.__N?n.__N[0]:n.__[0],r=n.t(t,e);t!==r&&(n.__N=[r,n.__[1]],n.__c.setState({}))}],n.__c=Cr,!Cr.__f)){var r=function(e,t,r){if(!n.__c.__H)return!0;var s=n.__c.__H.__.filter(function(e){return!!e.__c});if(s.every(function(e){return!e.__N}))return!o||o.call(this,e,t,r);var i=n.__c.props!==e;return s.forEach(function(e){if(e.__N){var t=e.__[0];e.__=e.__N,e.__N=void 0,t!==e.__[0]&&(i=!0)}}),o&&o.call(this,e,t,r)||i};Cr.__f=!0;var o=Cr.shouldComponentUpdate,s=Cr.componentWillUpdate;Cr.componentWillUpdate=function(e,t,n){if(this.__e){var i=o;o=void 0,r(e,t,n),o=i}s&&s.call(this,e,t,n)},Cr.shouldComponentUpdate=r}return n.__N||n.__}(Gr,e)}function Fr(e){return Ur=5,function(e,t){var n=Mr(Or++,7);return qr(n.__H,t)&&(n.__=e(),n.__H=t,n.__h=e),n.__}(function(){return{current:e}},[])}function Kr(){for(var e;e=Pr.shift();)if(e.__P&&e.__H)try{e.__H.__h.forEach(zr),e.__H.__h.forEach(Jr),e.__H.__h=[]}catch(t){e.__H.__h=[],Ar.__e(t,e.__v)}}Ar.__b=function(e){Cr=null,$r&&$r(e)},Ar.__=function(e,t){e&&t.__k&&t.__k.__m&&(e.__m=t.__k.__m),Br&&Br(e,t)},Ar.__r=function(e){Dr&&Dr(e),Or=0;var t=(Cr=e.__c).__H;t&&(jr===Cr?(t.__h=[],Cr.__h=[],t.__.forEach(function(e){e.__N&&(e.__=e.__N),e.u=e.__N=void 0})):(t.__h.forEach(zr),t.__h.forEach(Jr),t.__h=[],Or=0)),jr=Cr},Ar.diffed=function(e){Lr&&Lr(e);var t=e.__c;t&&t.__H&&(t.__H.__h.length&&(1!==Pr.push(t)&&Tr===Ar.requestAnimationFrame||((Tr=Ar.requestAnimationFrame)||Vr)(Kr)),t.__H.__.forEach(function(e){e.u&&(e.__H=e.u),e.u=void 0})),jr=Cr=null},Ar.__c=function(e,t){t.some(function(e){try{e.__h.forEach(zr),e.__h=e.__h.filter(function(e){return!e.__||Jr(e)})}catch(n){t.some(function(e){e.__h&&(e.__h=[])}),t=[],Ar.__e(n,e.__v)}}),Rr&&Rr(e,t)},Ar.unmount=function(e){Nr&&Nr(e);var t,n=e.__c;n&&n.__H&&(n.__H.__.forEach(function(e){try{zr(e)}catch(e){t=e}}),n.__H=void 0,t&&Ar.__e(t,n.__v))};var Hr="function"==typeof requestAnimationFrame;function Vr(e){var t,n=function(){clearTimeout(r),Hr&&cancelAnimationFrame(t),setTimeout(e)},r=setTimeout(n,35);Hr&&(t=requestAnimationFrame(n))}function zr(e){var t=Cr,n=e.__c;"function"==typeof n&&(e.__c=void 0,n()),Cr=t}function Jr(e){var t=Cr;e.__c=e.__(),Cr=t}function qr(e,t){return!e||e.length!==t.length||t.some(function(t,n){return t!==e[n]})}function Gr(e,t){return"function"==typeof t?t(e):t}function Yr({title:e,type:t,alerts:n,fields:r,submitLabel:o,cancelLabel:s,onCancel:i,onSubmit:a}){const[l,c]=Wr({}),u=Fr(null);return function(e,t){var n=Mr(Or++,4);!Ar.__s&&qr(n.__H,t)&&(n.__=e,n.u=t,Cr.__h.push(n))}(()=>{var e;return null===(e=u.current)||void 0===e?void 0:e.focus()},[]),nr(Er,{className:"dxc-login-dlg"},nr(or,null,nr("h3",{style:Ir.WindowHeader},e),n.map(e=>nr("p",{style:Ir.Alert[e.type]},function({message:e,messageCode:t,messageParams:n}){return e.replace(/\{\w+\}/gi,e=>n[e.substring(1,e.length-1)])}(e))),nr("form",{onSubmit:e=>{e.preventDefault(),a(l)}},Object.entries(r).map(([e,{type:t,label:n,placeholder:r}],o)=>nr("label",{style:Ir.Label,key:o},n?`${n}: `:"",nr("input",{ref:0===o?u:void 0,type:t,name:e,autoComplete:"on",style:Ir.Input,autoFocus:!0,placeholder:r,value:l[e]||"",onInput:n=>{var r;const o=function(e,t){switch(e){case"email":return t.toLowerCase();case"otp":return t.toUpperCase();default:return t}}(t,null===(r=n.target)||void 0===r?void 0:r.value);let s=Object.assign(Object.assign({},l),{[e]:o});c(s),"otp"===t&&8===(null==o?void 0:o.trim().length)&&a(s)}}))))),nr("div",{style:Ir.ButtonsDiv},nr(or,null,nr("button",{type:"submit",style:Ir.PrimaryButton,onClick:()=>a(l)},o),s&&nr("button",{style:Ir.Button,onClick:i},s))))}class Zr extends sr{constructor(e){super(e),this.observer=e=>this.setState({userInteraction:e}),this.state={userInteraction:void 0}}componentDidMount(){this.subscription=c(this.props.db.cloud.userInteraction).subscribe(this.observer)}componentWillUnmount(){this.subscription&&(this.subscription.unsubscribe(),delete this.subscription)}render(e,{userInteraction:t}){return t?nr(Yr,Object.assign({},t)):null}}function Xr(e){const t=new WeakMap;return n=>{let r=t.get(n);return r||(r=e(n),t.set(n,r)),r}}const Qr=Xr(e=>new i(ne));function eo(e,t){let n=t,r=c(e).pipe(_(e=>n=e),w({resetOnRefCountZero:()=>k(1e3)}));const o=new s(e=>{let t=!1;const o=r.subscribe({next(n){t=!0,e.next(n)},error(t){e.error(t)},complete(){e.complete()}});return t||o.closed||e.next(n),o});return o.getValue=()=>n,o}const to=Xr(e=>eo(o(()=>e.roles.where({realmId:"rlm-public"}).toArray().then(e=>{const t={};for(const n of e.slice().sort((e,t)=>(e.sortOrder||0)-(t.sortOrder||0)))t[n.name]=n;return t})),{})),no=Xr(e=>eo(Qr(e._novip).pipe(I(t=>o(()=>e.transaction("r","realms","members",()=>Promise.all([e.members.where({userId:t.userId}).toArray(),e.realms.toArray(),t.userId]).then(([e,t,n])=>({selfMembers:e,realms:t,userId:n})))))),{selfMembers:[],realms:[],get userId(){return e.cloud.currentUserId}}));function ro(...e){if(0===e.length)return{};const t=e.reduce((e,t)=>{const n=Object.assign({},e);for(const[e,r]of Object.entries(t))if(e in n&&n[e]){if("*"===n[e])continue;if("*"===r)n[e]="*";else if(Array.isArray(r)&&Array.isArray(n[e])){const t=n,o=t[e];t[e]=[...new Set([...o,...r])]}else if("object"==typeof r&&r&&"object"==typeof n[e]){const t=n[e];for(const[e,n]of Object.entries(r))"*"!==t[e]&&("*"===n?t[e]="*":Array.isArray(t[e])&&Array.isArray(n)&&(t[e]=[...new Set([...t[e],...n])]))}}else n[e]=t[e];return n});return t}const oo=Xr(e=>function(e,t){let n;const r=e.pipe(_(e=>n=t(e)));return r.getValue=()=>void 0!==n?n:n=t(e.getValue()),r}(eo(g([no(e._novip),to(e._novip)]).pipe(C(([{selfMembers:e,realms:t,userId:n},r])=>({selfMembers:e,realms:t,userId:n,globalRoles:r}))),{selfMembers:[],realms:[],userId:ne.userId,globalRoles:{}}),({selfMembers:e,realms:t,userId:n,globalRoles:r})=>{const o=t.map(t=>{const o=e.filter(e=>e.realmId===t.realmId),s=o.map(e=>e.permissions).filter(e=>e),i=_e(o.map(e=>e.roles).filter(e=>e)).map(e=>r[e]).filter(e=>e).map(e=>e.permissions);return Object.assign(Object.assign({},t),{permissions:t.owner===n?{manage:"*"}:ro(...s,...i)})}).reduce((e,t)=>Object.assign(Object.assign({},e),{[t.realmId]:t}),{[n]:{realmId:n,owner:n,name:n,permissions:{manage:"*"}}});return o}));class so{constructor(e,t,n){this.permissions=e||{},this.tableName=t,this.isOwner=n}add(...e){var t;return"*"===this.permissions.manage||(!!(null===(t=this.permissions.manage)||void 0===t?void 0:t.includes(this.tableName))||("*"===this.permissions.add||!!e.every(e=>{var t;return null===(t=this.permissions.add)||void 0===t?void 0:t.includes(e)})))}update(...e){var t,n;if(this.isOwner||"*"===this.permissions.manage)return!0;if(null===(t=this.permissions.manage)||void 0===t?void 0:t.includes(this.tableName))return!0;if("*"===this.permissions.update)return e.every(e=>"owner"!==e);const r=null===(n=this.permissions.update)||void 0===n?void 0:n[this.tableName];return"*"===r?e.every(e=>"owner"!==e):e.every(e=>null==r?void 0:r.some(t=>t===e||"*"===t&&"owner"!==e))}delete(){var e;return!(!this.isOwner&&"*"!==this.permissions.manage)||!!(null===(e=this.permissions.manage)||void 0===e?void 0:e.includes(this.tableName))}}const io=Xr(e=>{const t=Qr(e._novip).pipe(I(t=>o(()=>e.members.where({email:t.email||""}).toArray()))),n=oo(e._novip),r=no(e._novip);return eo(g([t,r,n]).pipe(C(([t,n,r])=>{const o=(e,t)=>Object.assign(Object.assign({},e),{[t.id]:Object.assign(Object.assign({},t),{realm:r[t.realmId]})}),s=t.reduce(o,{}),i=n.selfMembers.reduce(o,s);return Object.values(i).filter(e=>!e.accepted).map(t=>Object.assign(Object.assign({},t),{accept(){return Z(this,void 0,void 0,function*(){yield e.members.update(t.id,{accepted:new Date})})},reject(){return Z(this,void 0,void 0,function*(){yield e.members.update(t.id,{rejected:new Date})})}}))})),[])});function ao(e){return t=>{var r;const o=t.doc;if(!o)throw new Error("Internal error: DexieYProvider.createYHandler called without a doc. This is unexpected.");const{parentTable:s}=o.meta||{};if(!(null===(r=e.cloud.schema)||void 0===r?void 0:r[s].markedForSync))return;let i;Object.defineProperty(t,"awareness",{get:()=>i||(i=function(e,t,r){const{parentTable:o,parentId:s,parentProp:i,updatesTable:a}=t.meta,l=new Y.Awareness(t),c=Cn(t);return l.on("update",({added:n,updated:s,removed:a},c)=>{const u=n.concat(s).concat(a),d=e.cloud.currentUser.value;if("server"!==c&&d.isLoggedIn&&!hn(e)){const n=Y.encodeAwarenessUpdate(l,u);e.messageProducer.next({type:"aware",table:o,prop:i,k:t.meta.parentId,u:n}),r.destroyed&&e.messageProducer.next({type:"doc-close",table:o,prop:i,k:t.meta.parentId})}}),l.on("destroy",()=>{Y.removeAwarenessStates(l,[t.clientID],"provider destroyed")}),(()=>{Z(this,void 0,void 0,function*(){if(r.destroyed)return;let t=!1,l=1;const u=g([e.cloud.webSocketStatus,c.pipe(S(null))]).subscribe(([n])=>{if(r.destroyed)return;t="connected"===n;const o=e.cloud.currentUser.value;"connected"===n&&o.isLoggedIn&&!hn(e)&&(++l,d().catch(e=>{}))});function d(){return Z(this,void 0,void 0,function*(){const c=l,u=e.table(a),d=e.$syncState,[f,p]=yield e.transaction("r",d,u,()=>Z(this,void 0,void 0,function*(){const e=yield u.get(Ct),t=yield d.get("syncState");return[(null==e?void 0:e.receivedUntil)||0,(null==t?void 0:t.yServerRevision)||(null==t?void 0:t.serverRevision)]}));if(r.destroyed||l!==c||!t)return;const y={type:"doc-open",table:o,prop:i,k:s,serverRev:p},h=yield u.where("i").between(f,1/0,!1).filter(e=>0===n(e.k,s)&&!(1&(e.f||0))).toArray();if(!r.destroyed&&l===c&&t){if(h.length>0){const e=q.mergeUpdatesV2(h.map(e=>e.u)),t=q.encodeStateVectorFromUpdateV2(e);y.sv=t}e.messageProducer.next(y)}})}r.addCleanupHandler(u)})})(),l}(e,o,t),En.set(o,i),i)})}}const lo={nameSuffix:!0};function co(t){const n=t.name,r=Qr(t),s=[];let u=!1,y=null;t.on("ready",t=>Z(this,void 0,void 0,function*(){try{yield function(t){return Z(this,void 0,void 0,function*(){var n,l,_,w,k,S,E;h=!1;const j=Wt(t);"undefined"!=typeof window&&"undefined"!=typeof document&&((null===(n=j.cloud.options)||void 0===n?void 0:n.customLoginGui)||s.push(function(e){let t=!1;const n=document.createElement("div");return document.body?(document.body.appendChild(n),xr(nr(Zr,{db:e.vip}),n)):addEventListener("DOMContentLoaded",()=>{t||(document.body.appendChild(n),xr(nr(Zr,{db:e.vip}),n))}),{unsubscribe(){try{n.remove()}catch(e){}t=!0},get closed(){return t}}}(t))),j.cloud.isServiceWorkerDB||s.push(function(e){let t=e.cloud.webSocketStatus.value;const n=e.cloud.webSocketStatus.pipe(I(e=>{const n=t;t=e;const r=d(e);switch(e){case"disconnected":return gn.value?r.pipe(P(500)):r;case"connecting":return"not-started"===n||"error"===n?r:r.pipe(P(4e3));default:return r}}));return g([n,e.syncStateChangedEvent.pipe(A({phase:"initial"})),Qr(e.dx._novip),_n]).pipe(C(([t,n,r,o])=>{var s;if((null===(s=r.license)||void 0===s?void 0:s.status)&&"ok"!==r.license.status)return{phase:"offline",status:"offline",license:r.license.status};let{phase:i,error:a,progress:l}=n,c=t;return"error"===i&&(c="error"),"not-started"===t&&("pushing"!==i&&"pulling"!==i||(c="connecting")),"error"!==e.cloud.syncState.value.phase||"pushing"!==n.phase&&"pulling"!==n.phase||(c="connecting"),o||(c="disconnected"),{phase:i,error:a,progress:l,status:St?c:"offline",license:"ok"}}))}(j).subscribe(t.cloud.syncState)),s.push(j.syncCompleteEvent.subscribe(v)),j.tables.every(e=>e.core)||function(){throw new e.SchemaError("Version increment needed to allow dexie-cloud change tracking")}();const D="serviceWorker"in navigator?yield navigator.serviceWorker.getRegistrations():[],[L,R]=yield j.transaction("rw",j.$syncState,()=>Z(this,void 0,void 0,function*(){var e,t;const{options:n,schema:r}=j.cloud,[o,s,i]=yield Promise.all([j.getOptions(),j.getSchema(),j.getPersistedSyncState()]);if(u){if(!o||JSON.stringify(o)!==JSON.stringify(n)){if(!n)throw new Error("Internal error");const e=Object.assign({},n);delete e.fetchTokens,delete e.awarenessProtocol,yield j.$syncState.put(e,"options")}}else j.cloud.options=o||null;if((null===(e=j.cloud.options)||void 0===e?void 0:e.tryUseServiceWorker)&&"serviceWorker"in navigator&&D.length>0&&!Qt?j.cloud.usingServiceWorker=!0:((null===(t=j.cloud.options)||void 0===t?void 0:t.tryUseServiceWorker)&&j.cloud.isServiceWorkerDB,j.cloud.usingServiceWorker=!1),Nn(r,j.cloud.options),Nn(s,j.cloud.options),r){if(!s||JSON.stringify(s)!==JSON.stringify(r)){const e=s||{};for(const[t,n]of Object.entries(r)){const r=e[t];r?(r.markedForSync=n.markedForSync,n.deleted=r.deleted,r.generatedGlobalId=n.generatedGlobalId):e[t]=Object.assign({},n)}yield j.$syncState.put(e,"schema"),Object.assign(r,e)}}else j.cloud.schema=s||null;return[null==i?void 0:i.initiallySynced,null==i?void 0:i.realms]}));if(L&&j.setInitiallySynced(!0),function(t){var n,r;for(const o of t.tables)if(null===(r=null===(n=t.cloud.schema)||void 0===n?void 0:n[o.name])||void 0===r?void 0:r.markedForSync){if(o.schema.primKey.auto)throw new e.SchemaError(`Table ${o.name} is both autoIncremented and synced. Use db.cloud.configure({unsyncedTables: [${JSON.stringify(o.name)}]}) to blacklist it from sync`);if(!o.schema.primKey.keyPath)throw new e.SchemaError(`Table ${o.name} cannot be both synced and outbound. Use db.cloud.configure({unsyncedTables: [${JSON.stringify(o.name)}]}) to blacklist it from sync`)}}(j),m(),!j.cloud.isServiceWorkerDB){s.push(o(()=>j.getCurrentUser()).subscribe(r)),s.push(o(()=>j.getPersistedSyncState()).subscribe(j.cloud.persistedSyncState)),yield a(g([r.pipe($(1),T(1)),j.cloud.persistedSyncState.pipe($(1),T(1))]));const e=ao(j);G.on.new.subscribe(e),j.dx.once("close",()=>{G.on.new.unsubscribe(e)})}let N=!1;const B=yield j.getCurrentUser(),M=null===(l=j.cloud.options)||void 0===l?void 0:l.requireAuth;M&&(j.cloud.isServiceWorkerDB?yield a(r.pipe(x(e=>!!e.isLoggedIn),T(1))):"object"==typeof M?(!B.isLoggedIn||M.userId&&B.userId!==M.userId||M.email&&B.email!==M.email)&&(N=yield Gt(j,M)):B.isLoggedIn||(N=yield Gt(j))),!B.isLoggedIn||R&&R.includes(B.userId)||(N=!0),y&&y.stop(),y=null,m();const W=(null===(_=j.cloud.options)||void 0===_?void 0:_.databaseUrl)&&(!L||N);W&&(yield function(e,t,n){return Z(this,void 0,void 0,function*(){yield bn(e,At,()=>$t(e,t,n,{isInitialSync:!0}))})}(j,j.cloud.options,j.cloud.schema),j.setInitiallySynced(!0)),m(),j.cloud.usingServiceWorker&&(null===(w=j.cloud.options)||void 0===w?void 0:w.databaseUrl)?(W||ce(j,"push").catch(()=>{}),function(e){return Z(this,void 0,void 0,function*(){var t;try{const{periodicSync:n}=yield navigator.serviceWorker.ready;if(n)try{yield n.register(`dexie-cloud:${e.name}`,null===(t=e.cloud.options)||void 0===t?void 0:t.periodicSync)}catch(e){}}catch(e){}})}(j).catch(()=>{})):(null===(k=j.cloud.options)||void 0===k?void 0:k.databaseUrl)&&j.cloud.schema&&!j.cloud.isServiceWorkerDB&&(y=Rn(j,j.cloud.options,j.cloud.schema),y.start(),W||ue(j,"push")),m(),j.cloud.isServiceWorkerDB||s.push(f(self,"online").subscribe(()=>{j.syncStateChangedEvent.next({phase:"not-in-sync"}),hn(j)||ue(j,"push")}),f(self,"offline").subscribe(()=>{j.syncStateChangedEvent.next({phase:"offline"})})),!(null===(S=j.cloud.options)||void 0===S?void 0:S.databaseUrl)||(null===(E=j.cloud.options)||void 0===E?void 0:E.disableWebSocket)||en||s.push(function(e){var t;if(!(null===(t=e.cloud.options)||void 0===t?void 0:t.databaseUrl))throw new Error("No database URL to connect WebSocket to");const n=e.messageConsumer.readyToServe.pipe(x(e=>e),I(()=>e.getPersistedSyncState()),x(e=>e&&e.serverRevision),I(e=>Z(this,void 0,void 0,function*(){return{type:"ready",rev:e.serverRevision,realmSetHash:yield he(e)}}))),r=p(n,e.messageProducer);return function t(){return e.cloud.persistedSyncState.pipe(x(e=>null==e?void 0:e.serverRevision),T(1),I(t=>e.cloud.currentUser.pipe(C(e=>[e,t]))),I(([e,t])=>_n.pipe(C(n=>[n?e:null,t]))),I(([t,n])=>(null==t?void 0:t.isLoggedIn)&&!(null==n?void 0:n.realms.includes(t.userId))?e.cloud.persistedSyncState.pipe(x(e=>(null==e?void 0:e.realms.includes(t.userId))||!1),T(1),C(e=>[t,e])):new i([t,n])),I(e=>Z(this,[e],void 0,function*([e,t]){return[e,yield he(t)]})),O(([e,t],[n,r])=>e===n&&t===r),I(([n,o])=>{var s;return(null===(s=e.cloud.persistedSyncState)||void 0===s?void 0:s.value)?n?new jn(e,e.cloud.persistedSyncState.value.serverRevision,e.cloud.persistedSyncState.value.yServerRevision,o,e.cloud.persistedSyncState.value.clientIdentity,r,e.cloud.webSocketStatus,n):c([]):t()}),U(n=>"TokenExpiredError"===(null==n?void 0:n.name)?d(!0).pipe(I(()=>Z(this,void 0,void 0,function*(){const t=yield e.getCurrentUser(),n=yield Be(e.cloud.options.databaseUrl,t);yield e.table("$logins").update(t.userId,{accessToken:n.accessToken,accessTokenExpiration:n.accessTokenExpiration,claims:n.claims,license:n.license,data:n.data})})),I(()=>t())):b(()=>n)),U(n=>(e.cloud.webSocketStatus.next("error"),n instanceof Pn?b(()=>n):c(An()).pipe(I(()=>t())))))}().subscribe({next:t=>{t&&e.messageConsumer.enqueue(t)},error:e=>{},complete:()=>{}})}(j))})}(t)}catch(e){}}),!0);let h=!1;function m(){if(h)throw new e.DatabaseClosedError}t.once("close",()=>{s.forEach(e=>e.unsubscribe()),s.splice(0,s.length),h=!0,y&&y.stop(),y=null,r.next(ne)});const v=new l;var _;t.cloud={version:"4.2.5",options:Object.assign({},lo),schema:null,get currentUserId(){return r.value.userId||ne.userId},currentUser:r,syncState:new i({phase:"initial",status:"not-started"}),events:{syncComplete:v},persistedSyncState:new i(void 0),userInteraction:new i(void 0),webSocketStatus:new i("not-started"),login(e){return Z(this,void 0,void 0,function*(){const n=Wt(t);yield n.cloud.sync(),yield Gt(n,e)})},invites:io(t),roles:to(t),configure(e){e=t.cloud.options=Object.assign(Object.assign({},t.cloud.options),e),u=!0,e.databaseUrl&&e.nameSuffix&&(t.name=`${n}-${function(e){const t=new URL(e);return"/"===t.pathname?t.hostname.split(".")[0]:t.pathname.split("/")[1]}(e.databaseUrl)}`,Wt(t).reconfigure()),Nn(t.cloud.schema,t.cloud.options)},logout(){return Z(this,arguments,void 0,function*({force:e}={}){e?yield Jt(Wt(t),{deleteUnsyncedData:!0}):yield zt(Wt(t))})},sync(){return Z(this,arguments,void 0,function*({wait:e,purpose:n}={wait:!0,purpose:"push"}){var r;void 0===e&&(e=!0);const s=Wt(t);if("ok"!==((null===(r=s.cloud.currentUser.value.license)||void 0===r?void 0:r.status)||"ok")&&(yield Re(s)),"pull"===n){const t=s.cloud.persistedSyncState.value;if(ue(s,n),e){const e=yield a(s.cloud.persistedSyncState.pipe(x(e=>null!=(null==e?void 0:e.timestamp)&&(!t||e.timestamp>t.timestamp))));if(null==e?void 0:e.error)throw new Error("Sync error: "+e.error)}}else if(yield $n(s)){const t=s.cloud.persistedSyncState.value;ue(s,n),e&&(yield a(c(o(()=>Z(this,void 0,void 0,function*(){const e=yield $n(s),n=yield s.getPersistedSyncState();if((null==n?void 0:n.timestamp)!==(null==t?void 0:t.timestamp)&&(null==n?void 0:n.error))throw new Error("Sync error: "+n.error);return e}))).pipe(x(e=>!e))))}})},permissions:(e,n)=>function(e,t,n){if(!t)throw new TypeError("Cannot check permissions of undefined or null. A Dexie Cloud object with realmId and owner expected.");const{owner:r,realmId:o}=t;if(!n){if("function"!=typeof t.table)throw new TypeError("Missing 'table' argument to permissions and table could not be extracted from entity");n=t.table()}const s=oo(e),i=t=>{const s=t[o||e.cloud.currentUserId];return s?new so(s.permissions,n,void 0===o||o===e.cloud.currentUserId||r===e.cloud.currentUserId):new so({},n,!r||r===e.cloud.currentUserId)},a=s.pipe(C(i));return a.getValue=()=>i(s.getValue()),a}(t._novip,e,n)},t.Version.prototype._parseStoresSpec=e.override(t.Version.prototype._parseStoresSpec,e=>vn(e,t)),t.Table.prototype.newId=function({colocateWith:e}={}){const n=e&&e.substr(e.length-3);return cn(t.cloud.schema[this.name].idPrefix||"",n)},t.Table.prototype.idPrefix=function(){var e,t;return(null===(t=null===(e=this.db.cloud.schema)||void 0===e?void 0:e[this.name])||void 0===t?void 0:t.idPrefix)||""},t.use(mn({currentUserObservable:t.cloud.currentUser,db:Wt(t)})),t.use((_=Wt(t),{stack:"dbcore",name:"implicitPropSetterMiddleware",level:1,create:e=>Object.assign(Object.assign({},e),{table:t=>{const n=e.table(t);return Object.assign(Object.assign({},n),{mutate:e=>{var r,o,s,i,a,l;const c=e.trans;if(c.disableChangeTracking)return n.mutate(e);const u=null!==(o=null===(r=c.currentUser)||void 0===r?void 0:r.userId)&&void 0!==o?o:ne.userId;if((null===(i=null===(s=_.cloud.schema)||void 0===s?void 0:s[t])||void 0===i?void 0:i.markedForSync)&&("add"===e.type||"put"===e.type)){if("members"===t)for(const t of e.values)"string"==typeof t.email&&(t.email=t.email.trim().toLowerCase());for(const t of e.values){t.owner||(t.owner=u),t.realmId||(t.realmId=u);const r=null===(l=(a=n.schema.primaryKey).extractKey)||void 0===l?void 0:l.call(a,t);"string"==typeof r&&"#"===r[0]&&"put"===e.type&&(delete e.criteria,delete e.changeSpec,e.upsert||delete e.updates,t.$ts=Date.now())}}return n.mutate(e)}})}})})),t.use(un(Wt(t)))}co.version="4.2.5",e.Cloud=co;const uo=new Map;function fo(e){return e.startsWith("dexie-cloud:")&&e.split(":")[1]}const po=new Map;function yo(t,n){let r=po.get(t+"/"+n);return r||(r=function t(n,r){return Z(this,void 0,void 0,function*(){var o;let s=uo.get(n);if(!s){const o=new e(n,{addons:[co]});if(s=Wt(o),s.cloud.isServiceWorkerDB=!0,o.on("versionchange",i),yield s.dx.open(),uo.get(n))return s.close(),yield t(n,r);uo.set(n,s)}if((null===(o=s.cloud.options)||void 0===o?void 0:o.databaseUrl)&&s.cloud.schema)try{yield Ln(s,s.cloud.options,s.cloud.schema,{retryImmediatelyOnFetchError:!0,purpose:r})}catch(t){if(i(),t.name!==e.errnames.NoSuchDatabase)throw t}function i(){return s.dx.on.versionchange.unsubscribe(i),uo.get(s.name)===s&&uo.delete(s.name),s.dx.close(),!1}})}(t,n).then(()=>{po.delete(t+"/"+n)}).catch(e=>(po.delete(t+"/"+n),Promise.reject(e))),po.set(t+"/"+n,r)),r}Qt||(self.addEventListener("sync",e=>{const t=fo(e.tag);t&&e.waitUntil(yo(t,"push"))}),self.addEventListener("periodicsync",e=>{const t=fo(e.tag);t&&e.waitUntil(yo(t,"pull"))}),self.addEventListener("message",e=>{if("dexie-cloud-sync"===e.data.type){const{dbName:t}=e.data,n=(r=1)=>yo(t,e.data.purpose||"pull").catch(e=>Z(void 0,void 0,void 0,function*(){if(3===r)throw e;var t;yield(t=6e4,new Promise(e=>setTimeout(e,t))),n(r+1)}));"waitUntil"in e?e.waitUntil(n().catch(e=>{})):n().catch(e=>{})}}));
//# sourceMappingURL=service-worker.min.js.map
